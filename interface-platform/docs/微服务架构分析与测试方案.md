# ç”µåŠ›äº¤æ˜“ä¸­å¿ƒæ¥å£æœåŠ¡å¹³å° - å¾®æœåŠ¡æ¶æ„åˆ†æä¸æµ‹è¯•æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024-01-15  
**åˆ†æèŒƒå›´**: å¾®æœåŠ¡æ¶æ„ã€é€šä¿¡æœºåˆ¶ã€æµ‹è¯•ç­–ç•¥  

---

## ğŸ“Š å¾®æœåŠ¡æ¶æ„æ¦‚è§ˆ

### æœåŠ¡æ¸…å•

| æœåŠ¡åç§° | ç«¯å£ | èŒè´£ | çŠ¶æ€ |
|---------|------|------|------|
| gateway-service | 8080 | APIç½‘å…³ã€è·¯ç”±è½¬å‘ã€è®¤è¯é‰´æƒ | âœ… è¿è¡Œä¸­ |
| auth-service | 8081 | ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†ã€JWTç®¡ç† | âœ… è¿è¡Œä¸­ |
| user-service | 8081 | ç”¨æˆ·ç®¡ç†ã€è§’è‰²æƒé™ | âš ï¸ ç«¯å£å†²çª |
| interface-service | 8083 | æ¥å£ç®¡ç†ã€æ¥å£æ‰§è¡Œ | âœ… è¿è¡Œä¸­ |
| datasource-service | 8081 | æ•°æ®æºç®¡ç†ã€æŸ¥è¯¢æ‰§è¡Œ | âš ï¸ ç«¯å£å†²çª |
| approval-service | 8083 | è®¢é˜…ç”³è¯·ã€å®¡æ‰¹æµç¨‹ | âš ï¸ ç«¯å£å†²çª |
| notification-service | 8084 | æ¶ˆæ¯é€šçŸ¥ã€é‚®ä»¶å‘é€ | âœ… è¿è¡Œä¸­ |

### æ¶æ„ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[Frontend] --> B[Gateway Service]
    B --> C[Auth Service]
    B --> D[User Service]
    B --> E[Interface Service]
    B --> F[Approval Service]
    B --> G[Notification Service]
    E --> H[Datasource Service]
    F --> G
    C --> I[Redis]
    D --> J[MySQL]
    E --> J
    F --> J
    G --> J
    H --> K[Multiple Databases]
    
    L[Nacos] --> B
    L --> C
    L --> D
    L --> E
    L --> F
    L --> G
    L --> H
```

---

## ğŸ” æ¶æ„é—®é¢˜åˆ†æ

### 1. ç«¯å£å†²çªé—®é¢˜ (Critical)

**é—®é¢˜æè¿°**:
- `user-service`ã€`datasource-service` éƒ½é…ç½®ä¸ºç«¯å£ 8081
- `interface-service`ã€`approval-service` éƒ½é…ç½®ä¸ºç«¯å£ 8083

**å½±å“**:
- æœåŠ¡æ— æ³•åŒæ—¶å¯åŠ¨
- éƒ¨ç½²å†²çª
- æœåŠ¡å‘ç°å¼‚å¸¸

**ä¿®å¤å»ºè®®**:
```yaml
# å»ºè®®ç«¯å£åˆ†é…
gateway-service: 8080
auth-service: 8081
user-service: 8082
interface-service: 8083
approval-service: 8084
notification-service: 8085
datasource-service: 8086
```

### 2. æœåŠ¡å‘ç°é…ç½®ä¸ä¸€è‡´ (High)

**é—®é¢˜æè¿°**:
- éƒ¨åˆ†æœåŠ¡ç¼ºå°‘Nacosé…ç½®
- å‘½åç©ºé—´é…ç½®ä¸ç»Ÿä¸€
- æœåŠ¡åˆ†ç»„ä¸è§„èŒƒ

**ä¿®å¤å»ºè®®**:
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: interface-platform
        group: DEFAULT_GROUP
      config:
        server-addr: localhost:8848
        namespace: interface-platform
        group: DEFAULT_GROUP
        file-extension: yml
```

### 3. ç¼ºå°‘ç†”æ–­å™¨å’Œé™æµ (High)

**é—®é¢˜æè¿°**:
- æœåŠ¡é—´è°ƒç”¨ç¼ºå°‘ç†”æ–­ä¿æŠ¤
- æ— é™æµæœºåˆ¶
- ç¼ºå°‘é™çº§ç­–ç•¥

**ä¿®å¤å»ºè®®**:
```java
@Component
public class ServiceFallback {
    
    @HystrixCommand(fallbackMethod = "fallbackMethod")
    public String callService() {
        // æœåŠ¡è°ƒç”¨é€»è¾‘
    }
    
    public String fallbackMethod() {
        return "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨";
    }
}
```

### 4. æœåŠ¡é—´é€šä¿¡å®‰å…¨ (Medium)

**é—®é¢˜æè¿°**:
- å†…éƒ¨æœåŠ¡é—´é€šä¿¡æœªåŠ å¯†
- ç¼ºå°‘æœåŠ¡é—´è®¤è¯
- æ— APIå¯†é’¥éªŒè¯

**ä¿®å¤å»ºè®®**:
1. å®æ–½mTLSåŠ å¯†
2. æœåŠ¡é—´JWTè®¤è¯
3. APIç½‘å…³ç»Ÿä¸€é‰´æƒ

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥è®¾è®¡

### 1. å•å…ƒæµ‹è¯• (Unit Testing)

#### æµ‹è¯•è¦†ç›–ç›®æ ‡
- **ä»£ç è¦†ç›–ç‡**: â‰¥ 80%
- **åˆ†æ”¯è¦†ç›–ç‡**: â‰¥ 70%
- **æ–¹æ³•è¦†ç›–ç‡**: â‰¥ 90%

#### æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹

**Auth Service æµ‹è¯•ç”¨ä¾‹**:
```java
@SpringBootTest
class AuthServiceTest {
    
    @Test
    void testUserLogin_ValidCredentials_Success() {
        // Given
        LoginRequest request = new LoginRequest("admin", "password");
        
        // When
        LoginResponse response = authService.login(request);
        
        // Then
        assertThat(response.isSuccess()).isTrue();
        assertThat(response.getToken()).isNotEmpty();
    }
    
    @Test
    void testUserLogin_InvalidCredentials_Failure() {
        // Given
        LoginRequest request = new LoginRequest("admin", "wrongpassword");
        
        // When & Then
        assertThrows(AuthenticationException.class, 
            () -> authService.login(request));
    }
    
    @Test
    void testJwtToken_Expired_ThrowsException() {
        // Given
        String expiredToken = generateExpiredToken();
        
        // When & Then
        assertThrows(TokenExpiredException.class,
            () -> jwtTokenUtil.validateToken(expiredToken));
    }
}
```

**Interface Service æµ‹è¯•ç”¨ä¾‹**:
```java
@SpringBootTest
class InterfaceExecutionServiceTest {
    
    @Test
    void testExecuteInterface_ValidParameters_Success() {
        // Given
        String interfaceId = "test-interface-001";
        Map<String, Object> params = Map.of("userId", "123");
        
        // When
        InterfaceExecutionResult result = 
            interfaceExecutionService.executeInterface(interfaceId, params);
        
        // Then
        assertThat(result.isSuccess()).isTrue();
        assertThat(result.getData()).isNotNull();
    }
    
    @Test
    void testExecuteInterface_SqlInjection_Blocked() {
        // Given
        String interfaceId = "test-interface-001";
        Map<String, Object> params = Map.of(
            "userId", "1; DROP TABLE users; --"
        );
        
        // When & Then
        assertThrows(SecurityException.class,
            () -> interfaceExecutionService.executeInterface(interfaceId, params));
    }
}
```

### 2. é›†æˆæµ‹è¯• (Integration Testing)

#### æœåŠ¡é—´é€šä¿¡æµ‹è¯•
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "spring.cloud.nacos.discovery.enabled=false"
})
class ServiceIntegrationTest {
    
    @Test
    void testUserServiceIntegration() {
        // æµ‹è¯•ç”¨æˆ·æœåŠ¡ä¸è®¤è¯æœåŠ¡çš„é›†æˆ
        given()
            .contentType(ContentType.JSON)
            .body(loginRequest)
        .when()
            .post("/api/auth/login")
        .then()
            .statusCode(200)
            .body("success", equalTo(true));
    }
    
    @Test
    void testInterfaceExecutionFlow() {
        // æµ‹è¯•å®Œæ•´çš„æ¥å£æ‰§è¡Œæµç¨‹
        // 1. ç”¨æˆ·è®¤è¯
        // 2. æ¥å£æƒé™æ£€æŸ¥
        // 3. å‚æ•°éªŒè¯
        // 4. æ•°æ®æºæŸ¥è¯¢
        // 5. ç»“æœè¿”å›
    }
}
```

### 3. å¥‘çº¦æµ‹è¯• (Contract Testing)

#### Pact æµ‹è¯•ç¤ºä¾‹
```java
@ExtendWith(PactConsumerTestExt.class)
@PactTestFor(providerName = "auth-service")
class AuthServiceContractTest {
    
    @Pact(consumer = "interface-service")
    public RequestResponsePact validateTokenPact(PactDslWithProvider builder) {
        return builder
            .given("valid token exists")
            .uponReceiving("a request to validate token")
            .path("/api/auth/validate")
            .method("POST")
            .headers(Map.of("Authorization", "Bearer valid-token"))
            .willRespondWith()
            .status(200)
            .body(new PactDslJsonBody()
                .booleanValue("valid", true)
                .stringValue("userId", "123"))
            .toPact();
    }
}
```

### 4. ç«¯åˆ°ç«¯æµ‹è¯• (E2E Testing)

#### ä¸šåŠ¡æµç¨‹æµ‹è¯•
```java
@SpringBootTest
@Testcontainers
class EndToEndTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("interface_platform")
            .withUsername("test")
            .withPassword("test");
    
    @Test
    void testCompleteInterfaceSubscriptionFlow() {
        // 1. ç”¨æˆ·æ³¨å†Œ
        registerUser("testuser", "password");
        
        // 2. ç”¨æˆ·ç™»å½•
        String token = loginUser("testuser", "password");
        
        // 3. æµè§ˆæ¥å£ç›®å½•
        List<Interface> interfaces = getInterfaceList(token);
        
        // 4. ç”³è¯·æ¥å£è®¢é˜…
        String applicationId = applyForSubscription(token, interfaces.get(0).getId());
        
        // 5. ç®¡ç†å‘˜å®¡æ‰¹
        approveApplication(adminToken, applicationId);
        
        // 6. è°ƒç”¨æ¥å£
        InterfaceResponse response = callInterface(token, interfaces.get(0).getId());
        
        // éªŒè¯ç»“æœ
        assertThat(response.isSuccess()).isTrue();
    }
}
```

### 5. æ€§èƒ½æµ‹è¯• (Performance Testing)

#### JMeter æµ‹è¯•è®¡åˆ’
```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan testname="Interface Platform Performance Test">
      <elementProp name="TestPlan.arguments" elementType="Arguments" guiclass="ArgumentsPanel">
        <collectionProp name="Arguments.arguments">
          <elementProp name="baseUrl" elementType="Argument">
            <stringProp name="Argument.name">baseUrl</stringProp>
            <stringProp name="Argument.value">http://localhost:8080</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
    </TestPlan>
    
    <hashTree>
      <ThreadGroup testname="Interface Call Load Test">
        <stringProp name="ThreadGroup.num_threads">100</stringProp>
        <stringProp name="ThreadGroup.ramp_time">60</stringProp>
        <stringProp name="ThreadGroup.duration">300</stringProp>
      </ThreadGroup>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

#### æ€§èƒ½æŒ‡æ ‡ç›®æ ‡
- **å“åº”æ—¶é—´**: P95 < 500ms
- **ååé‡**: > 1000 TPS
- **é”™è¯¯ç‡**: < 0.1%
- **CPUä½¿ç”¨ç‡**: < 70%
- **å†…å­˜ä½¿ç”¨ç‡**: < 80%

### 6. å®‰å…¨æµ‹è¯• (Security Testing)

#### OWASP ZAP è‡ªåŠ¨åŒ–æ‰«æ
```bash
#!/bin/bash
# å¯åŠ¨ZAPä»£ç†
zap.sh -daemon -host 0.0.0.0 -port 8090 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true

# æ‰§è¡ŒåŸºçº¿æ‰«æ
curl "http://localhost:8090/JSON/spider/action/scan/?url=http://localhost:8080&maxChildren=10"

# æ‰§è¡Œä¸»åŠ¨æ‰«æ
curl "http://localhost:8090/JSON/ascan/action/scan/?url=http://localhost:8080&recurse=true"

# ç”ŸæˆæŠ¥å‘Š
curl "http://localhost:8090/OTHER/core/other/htmlreport/" > security-report.html
```

#### å®‰å…¨æµ‹è¯•ç”¨ä¾‹
```java
@SpringBootTest
class SecurityTest {
    
    @Test
    void testSqlInjection() {
        // æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤
        String maliciousInput = "1' OR '1'='1";
        
        given()
            .param("userId", maliciousInput)
        .when()
            .get("/api/interfaces/search")
        .then()
            .statusCode(400); // åº”è¯¥è¢«æ‹¦æˆª
    }
    
    @Test
    void testXssProtection() {
        // æµ‹è¯•XSSé˜²æŠ¤
        String xssPayload = "<script>alert('xss')</script>";
        
        given()
            .contentType(ContentType.JSON)
            .body(Map.of("description", xssPayload))
        .when()
            .post("/api/interfaces")
        .then()
            .statusCode(400); // åº”è¯¥è¢«æ‹¦æˆª
    }
}
```

---

## ğŸ“‹ æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æµ‹è¯• (1å‘¨)
1. **å•å…ƒæµ‹è¯•ç¼–å†™å’Œæ‰§è¡Œ**
   - æ‰€æœ‰Serviceå±‚æ–¹æ³•
   - å·¥å…·ç±»å’Œå¸®åŠ©æ–¹æ³•
   - å¼‚å¸¸å¤„ç†é€»è¾‘

2. **é›†æˆæµ‹è¯•è®¾è®¡**
   - æ•°æ®åº“é›†æˆæµ‹è¯•
   - Redisé›†æˆæµ‹è¯•
   - å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼šç³»ç»Ÿæµ‹è¯• (1å‘¨)
1. **APIæµ‹è¯•**
   - æ‰€æœ‰RESTæ¥å£
   - å‚æ•°éªŒè¯
   - é”™è¯¯å¤„ç†

2. **ä¸šåŠ¡æµç¨‹æµ‹è¯•**
   - ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹
   - æ¥å£è®¢é˜…ç”³è¯·æµç¨‹
   - æ¥å£è°ƒç”¨æµç¨‹

### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½å’Œå®‰å…¨æµ‹è¯• (1å‘¨)
1. **æ€§èƒ½æµ‹è¯•**
   - è´Ÿè½½æµ‹è¯•
   - å‹åŠ›æµ‹è¯•
   - ç¨³å®šæ€§æµ‹è¯•

2. **å®‰å…¨æµ‹è¯•**
   - æ¼æ´æ‰«æ
   - æ¸—é€æµ‹è¯•
   - å®‰å…¨é…ç½®æ£€æŸ¥

### ç¬¬å››é˜¶æ®µï¼šç«¯åˆ°ç«¯æµ‹è¯• (3å¤©)
1. **å®Œæ•´ä¸šåŠ¡åœºæ™¯æµ‹è¯•**
2. **ç”¨æˆ·éªŒæ”¶æµ‹è¯•**
3. **ç”Ÿäº§ç¯å¢ƒéªŒè¯**

---

## ğŸ› ï¸ æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

### å•å…ƒæµ‹è¯•
- **JUnit 5**: æµ‹è¯•æ¡†æ¶
- **Mockito**: Mockæ¡†æ¶
- **AssertJ**: æ–­è¨€åº“
- **Testcontainers**: é›†æˆæµ‹è¯•å®¹å™¨

### APIæµ‹è¯•
- **REST Assured**: APIæµ‹è¯•æ¡†æ¶
- **Postman/Newman**: APIæµ‹è¯•å·¥å…·
- **WireMock**: æœåŠ¡Mock

### æ€§èƒ½æµ‹è¯•
- **JMeter**: è´Ÿè½½æµ‹è¯•å·¥å…·
- **Gatling**: é«˜æ€§èƒ½æµ‹è¯•å·¥å…·
- **Artillery**: è½»é‡çº§æ€§èƒ½æµ‹è¯•

### å®‰å…¨æµ‹è¯•
- **OWASP ZAP**: å®‰å…¨æ‰«æå·¥å…·
- **SonarQube**: ä»£ç å®‰å…¨åˆ†æ
- **Checkmarx**: é™æ€å®‰å…¨åˆ†æ

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šå’ŒæŒ‡æ ‡

### æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn clean test jacoco:report

# æŸ¥çœ‹æŠ¥å‘Š
open target/site/jacoco/index.html
```

### æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- **å“åº”æ—¶é—´åˆ†å¸ƒå›¾**
- **ååé‡è¶‹åŠ¿å›¾**
- **é”™è¯¯ç‡ç»Ÿè®¡**
- **èµ„æºä½¿ç”¨ç‡ç›‘æ§**

### å®‰å…¨æµ‹è¯•æŠ¥å‘Š
- **æ¼æ´ç­‰çº§åˆ†å¸ƒ**
- **ä¿®å¤å»ºè®®æ¸…å•**
- **åˆè§„æ€§æ£€æŸ¥ç»“æœ**

---

## ğŸ”„ æŒç»­é›†æˆæµ‹è¯•

### Jenkins Pipeline
```groovy
pipeline {
    agent any
    
    stages {
        stage('Unit Tests') {
            steps {
                sh 'mvn clean test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                    jacoco execPattern: 'target/jacoco.exec'
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                sh 'mvn verify -P integration-test'
            }
        }
        
        stage('Security Scan') {
            steps {
                sh 'mvn sonar:sonar'
            }
        }
        
        stage('Performance Test') {
            when {
                branch 'main'
            }
            steps {
                sh 'jmeter -n -t performance-test.jmx -l results.jtl'
            }
        }
    }
}
```

---

## ğŸ“ˆ è´¨é‡é—¨ç¦æ ‡å‡†

### ä»£ç è´¨é‡
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- ä»£ç é‡å¤ç‡ â‰¤ 3%
- ä»£ç å¤æ‚åº¦ â‰¤ 10
- æ— Criticalå’ŒHighçº§åˆ«çš„ä»£ç é—®é¢˜

### æ€§èƒ½æ ‡å‡†
- APIå“åº”æ—¶é—´P95 â‰¤ 500ms
- ç³»ç»Ÿååé‡ â‰¥ 1000 TPS
- é”™è¯¯ç‡ â‰¤ 0.1%
- å†…å­˜ä½¿ç”¨ç‡ â‰¤ 80%

### å®‰å…¨æ ‡å‡†
- æ— Criticalå’ŒHighçº§åˆ«å®‰å…¨æ¼æ´
- æ‰€æœ‰è¾“å…¥éªŒè¯å®Œæ•´
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- è®¿é—®æ§åˆ¶æœºåˆ¶å®Œå–„

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æ–‡æ¡£å°†æ ¹æ®æµ‹è¯•æ‰§è¡Œæƒ…å†µæŒç»­æ›´æ–°å’Œå®Œå–„ã€‚*