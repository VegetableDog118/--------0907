# ç”µåŠ›äº¤æ˜“ä¸­å¿ƒæ¥å£æœåŠ¡å¹³å° - æŒç»­é›†æˆè´¨é‡æ£€æŸ¥æµç¨‹

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024-01-15  
**é€‚ç”¨èŒƒå›´**: å¼€å‘ã€æµ‹è¯•ã€è¿ç»´å›¢é˜Ÿ  

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†ç”µåŠ›äº¤æ˜“ä¸­å¿ƒæ¥å£æœåŠ¡å¹³å°çš„æŒç»­é›†æˆè´¨é‡æ£€æŸ¥æµç¨‹ï¼Œç¡®ä¿ä»£ç è´¨é‡ã€å®‰å…¨æ€§å’Œæ€§èƒ½æ ‡å‡†å¾—åˆ°æŒç»­ç›‘æ§å’Œæ”¹è¿›ã€‚

---

## ğŸ”„ CI/CD æµæ°´çº¿æ¶æ„

```mermaid
graph LR
    A[ä»£ç æäº¤] --> B[ä»£ç æ£€æŸ¥]
    B --> C[å•å…ƒæµ‹è¯•]
    C --> D[é›†æˆæµ‹è¯•]
    D --> E[å®‰å…¨æ‰«æ]
    E --> F[æ€§èƒ½æµ‹è¯•]
    F --> G[æ„å»ºé•œåƒ]
    G --> H[éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ]
    H --> I[ç«¯åˆ°ç«¯æµ‹è¯•]
    I --> J[éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ]
    
    B --> K[è´¨é‡é—¨ç¦]
    C --> K
    D --> K
    E --> K
    F --> K
    I --> K
```

---

## ğŸšª è´¨é‡é—¨ç¦æ ‡å‡†

### 1. ä»£ç è´¨é‡é—¨ç¦

| æŒ‡æ ‡ | æ ‡å‡† | å·¥å…· |
|------|------|------|
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | â‰¥ 80% | JaCoCo |
| åˆ†æ”¯è¦†ç›–ç‡ | â‰¥ 70% | JaCoCo |
| ä»£ç é‡å¤ç‡ | â‰¤ 3% | SonarQube |
| ä»£ç å¤æ‚åº¦ | â‰¤ 10 | SonarQube |
| æŠ€æœ¯å€ºåŠ¡ | â‰¤ 1å¤© | SonarQube |
| ä»£ç å¼‚å‘³ | 0ä¸ª | SonarQube |

### 2. å®‰å…¨è´¨é‡é—¨ç¦

| æŒ‡æ ‡ | æ ‡å‡† | å·¥å…· |
|------|------|------|
| Criticalæ¼æ´ | 0ä¸ª | OWASP ZAP |
| Highçº§åˆ«æ¼æ´ | 0ä¸ª | OWASP ZAP |
| ä¾èµ–æ¼æ´æ‰«æ | æ— é«˜å± | OWASP Dependency Check |
| æ•æ„Ÿä¿¡æ¯æ³„éœ² | 0ä¸ª | GitLeaks |
| ä»£ç å®‰å…¨è¯„åˆ† | â‰¥ Açº§ | SonarQube Security |

### 3. æ€§èƒ½è´¨é‡é—¨ç¦

| æŒ‡æ ‡ | æ ‡å‡† | å·¥å…· |
|------|------|------|
| APIå“åº”æ—¶é—´P95 | â‰¤ 500ms | JMeter |
| ç³»ç»Ÿååé‡ | â‰¥ 1000 TPS | JMeter |
| é”™è¯¯ç‡ | â‰¤ 0.1% | JMeter |
| CPUä½¿ç”¨ç‡ | â‰¤ 70% | Prometheus |
| å†…å­˜ä½¿ç”¨ç‡ | â‰¤ 80% | Prometheus |

---

## ğŸ› ï¸ Jenkins Pipeline é…ç½®

### ä¸»æµæ°´çº¿ (Jenkinsfile)

```groovy
pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        SONAR_TOKEN = credentials('sonar-token')
        DOCKER_REGISTRY = 'registry.powertrading.com'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Code Quality Check') {
            parallel {
                stage('Compile') {
                    steps {
                        sh 'mvn clean compile -DskipTests'
                    }
                }
                
                stage('Code Style Check') {
                    steps {
                        sh 'mvn checkstyle:check'
                    }
                    post {
                        always {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'target/site',
                                reportFiles: 'checkstyle.html',
                                reportName: 'Checkstyle Report'
                            ])
                        }
                    }
                }
                
                stage('Security Scan - Secrets') {
                    steps {
                        sh 'gitleaks detect --source . --verbose'
                    }
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                    jacoco execPattern: 'target/jacoco.exec'
                }
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        mvn sonar:sonar \
                          -Dsonar.projectKey=interface-platform \
                          -Dsonar.host.url=$SONAR_HOST_URL \
                          -Dsonar.login=$SONAR_TOKEN
                    '''
                }
            }
        }
        
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                sh 'mvn verify -P integration-test'
            }
            post {
                always {
                    junit 'target/failsafe-reports/*.xml'
                }
            }
        }
        
        stage('Security Scan - OWASP') {
            steps {
                sh '''
                    mvn org.owasp:dependency-check-maven:check
                    docker run --rm -v $(pwd):/zap/wrk/:rw \
                      -t owasp/zap2docker-stable zap-baseline.py \
                      -t http://localhost:8080 -J zap-report.json
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'target',
                        reportFiles: 'dependency-check-report.html',
                        reportName: 'OWASP Dependency Check'
                    ])
                }
            }
        }
        
        stage('Build Docker Images') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    def services = ['gateway', 'auth', 'user', 'interface', 'approval', 'notification', 'datasource']
                    services.each { service ->
                        sh "docker build -t ${DOCKER_REGISTRY}/${service}-service:${env.GIT_COMMIT_SHORT} ./backend/${service}-service"
                        sh "docker push ${DOCKER_REGISTRY}/${service}-service:${env.GIT_COMMIT_SHORT}"
                    }
                }
            }
        }
        
        stage('Deploy to Test Environment') {
            when {
                branch 'develop'
            }
            steps {
                sh '''
                    helm upgrade --install interface-platform-test ./helm \
                      --namespace test \
                      --set image.tag=${GIT_COMMIT_SHORT} \
                      --set environment=test
                '''
            }
        }
        
        stage('Performance Tests') {
            when {
                branch 'develop'
            }
            steps {
                sh '''
                    # ç­‰å¾…æœåŠ¡å¯åŠ¨
                    sleep 60
                    
                    # æ‰§è¡Œæ€§èƒ½æµ‹è¯•
                    jmeter -n -t performance-tests/load-test.jmx \
                      -l performance-results.jtl \
                      -e -o performance-report
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'performance-report',
                        reportFiles: 'index.html',
                        reportName: 'Performance Test Report'
                    ])
                }
            }
        }
        
        stage('E2E Tests') {
            when {
                branch 'develop'
            }
            steps {
                sh '''
                    cd frontend
                    npm install
                    npm run test:e2e
                '''
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Deploy'
                sh '''
                    helm upgrade --install interface-platform ./helm \
                      --namespace production \
                      --set image.tag=${GIT_COMMIT_SHORT} \
                      --set environment=production
                '''
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            emailext (
                subject: "âœ… Build Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Build completed successfully. Check console output at ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
        failure {
            emailext (
                subject: "âŒ Build Failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Build failed. Check console output at ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

---

## ğŸ“Š ä»£ç è´¨é‡ç›‘æ§

### SonarQube é…ç½®

**sonar-project.properties**:
```properties
sonar.projectKey=interface-platform
sonar.projectName=Interface Platform
sonar.projectVersion=1.0

# æºç è·¯å¾„
sonar.sources=backend/*/src/main/java,frontend/src
sonar.tests=backend/*/src/test/java,frontend/src/**/*.spec.ts

# æ’é™¤æ–‡ä»¶
sonar.exclusions=**/*.xml,**/*.yml,**/target/**,**/node_modules/**

# æµ‹è¯•è¦†ç›–ç‡
sonar.java.coveragePlugin=jacoco
sonar.jacoco.reportPaths=target/jacoco.exec
sonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info

# è´¨é‡é—¨ç¦
sonar.qualitygate.wait=true
```

### è´¨é‡è§„åˆ™é…ç½®

**Quality Profile - Java**:
```json
{
  "name": "PowerTrading Java Rules",
  "language": "java",
  "rules": [
    {
      "key": "squid:S1192",
      "severity": "MAJOR",
      "params": {
        "threshold": "3"
      }
    },
    {
      "key": "squid:S3776",
      "severity": "CRITICAL",
      "params": {
        "threshold": "15"
      }
    }
  ]
}
```

---

## ğŸ”’ å®‰å…¨æ‰«æé…ç½®

### OWASP ZAP é…ç½®

**zap-baseline.conf**:
```
# å¿½ç•¥çš„URLæ¨¡å¼
ignore.url.pattern=.*\/swagger-ui\/.*
ignore.url.pattern=.*\/actuator\/.*

# æ‰«æç­–ç•¥
scan.policy=Default Policy

# æŠ¥å‘Šæ ¼å¼
report.format=HTML,JSON,XML

# è¶…æ—¶è®¾ç½®
timeout=300
```

### GitLeaks é…ç½®

**.gitleaks.toml**:
```toml
title = "PowerTrading GitLeaks Config"

[[rules]]
  description = "AWS Access Key"
  regex = '''AKIA[0-9A-Z]{16}'''
  tags = ["key", "AWS"]

[[rules]]
  description = "Database Password"
  regex = '''password\s*=\s*["'][^"'\s]{8,}["']'''
  tags = ["password", "database"]

[[rules]]
  description = "JWT Secret"
  regex = '''jwt[._-]?secret\s*[=:]\s*["'][^"'\s]{16,}["']'''
  tags = ["jwt", "secret"]

[allowlist]
  description = "Test files"
  paths = [
    '''.*test.*''',
    '''.*Test.*'''
  ]
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### JMeter æµ‹è¯•è®¡åˆ’

**load-test.jmx** (å…³é”®é…ç½®):
```xml
<TestPlan testname="Interface Platform Load Test">
  <elementProp name="TestPlan.arguments" elementType="Arguments">
    <collectionProp name="Arguments.arguments">
      <elementProp name="baseUrl" elementType="Argument">
        <stringProp name="Argument.value">${__P(baseUrl,http://localhost:8080)}</stringProp>
      </elementProp>
      <elementProp name="users" elementType="Argument">
        <stringProp name="Argument.value">${__P(users,100)}</stringProp>
      </elementProp>
      <elementProp name="rampUp" elementType="Argument">
        <stringProp name="Argument.value">${__P(rampUp,60)}</stringProp>
      </elementProp>
      <elementProp name="duration" elementType="Argument">
        <stringProp name="Argument.value">${__P(duration,300)}</stringProp>
      </elementProp>
    </collectionProp>
  </elementProp>
</TestPlan>
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬

**performance-test.sh**:
```bash
#!/bin/bash

# æ€§èƒ½æµ‹è¯•é…ç½®
BASE_URL="http://localhost:8080"
USERS=100
RAMP_UP=60
DURATION=300

# æ‰§è¡Œè´Ÿè½½æµ‹è¯•
echo "å¼€å§‹æ‰§è¡Œè´Ÿè½½æµ‹è¯•..."
jmeter -n -t load-test.jmx \
  -JbaseUrl=$BASE_URL \
  -Jusers=$USERS \
  -JrampUp=$RAMP_UP \
  -Jduration=$DURATION \
  -l results.jtl \
  -e -o report

# æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
echo "æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡..."
python3 check-performance.py results.jtl

if [ $? -eq 0 ]; then
    echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"
    exit 0
else
    echo "âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥"
    exit 1
fi
```

---

## ğŸš¨ å‘Šè­¦å’Œé€šçŸ¥

### Slack é€šçŸ¥é…ç½®

```groovy
// Jenkins Pipeline ä¸­çš„é€šçŸ¥
post {
    failure {
        slackSend(
            channel: '#dev-alerts',
            color: 'danger',
            message: "âŒ Build Failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}\n" +
                    "Branch: ${env.BRANCH_NAME}\n" +
                    "Commit: ${env.GIT_COMMIT_SHORT}\n" +
                    "Console: ${env.BUILD_URL}console"
        )
    }
    
    success {
        slackSend(
            channel: '#dev-notifications',
            color: 'good',
            message: "âœ… Build Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}\n" +
                    "Branch: ${env.BRANCH_NAME}\n" +
                    "Commit: ${env.GIT_COMMIT_SHORT}"
        )
    }
}
```

### é‚®ä»¶é€šçŸ¥æ¨¡æ¿

**email-template.html**:
```html
<!DOCTYPE html>
<html>
<head>
    <title>Build Notification</title>
    <style>
        .success { color: #28a745; }
        .failure { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h2 class="${BUILD_STATUS}">${BUILD_STATUS} - ${JOB_NAME} #${BUILD_NUMBER}</h2>
    
    <table>
        <tr><td><strong>é¡¹ç›®:</strong></td><td>${JOB_NAME}</td></tr>
        <tr><td><strong>åˆ†æ”¯:</strong></td><td>${BRANCH_NAME}</td></tr>
        <tr><td><strong>æäº¤:</strong></td><td>${GIT_COMMIT_SHORT}</td></tr>
        <tr><td><strong>ä½œè€…:</strong></td><td>${CHANGE_AUTHOR}</td></tr>
        <tr><td><strong>æ—¶é—´:</strong></td><td>${BUILD_TIMESTAMP}</td></tr>
        <tr><td><strong>æ§åˆ¶å°:</strong></td><td><a href="${BUILD_URL}console">æŸ¥çœ‹æ—¥å¿—</a></td></tr>
    </table>
    
    <h3>è´¨é‡æŒ‡æ ‡</h3>
    <ul>
        <li>ä»£ç è¦†ç›–ç‡: ${CODE_COVERAGE}%</li>
        <li>å®‰å…¨æ¼æ´: ${SECURITY_ISSUES}</li>
        <li>æ€§èƒ½æµ‹è¯•: ${PERFORMANCE_RESULT}</li>
    </ul>
</body>
</html>
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### å¼€å‘è€…æäº¤å‰æ£€æŸ¥
- [ ] ä»£ç æ ¼å¼åŒ–å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™å¹¶é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥å®Œæˆ
- [ ] æ•æ„Ÿä¿¡æ¯å·²ç§»é™¤
- [ ] æ–‡æ¡£å·²æ›´æ–°

### CIæµæ°´çº¿æ£€æŸ¥
- [ ] ç¼–è¯‘æˆåŠŸ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡è¾¾æ ‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æ‰€æœ‰è´¨é‡é—¨ç¦é€šè¿‡
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å‡†å¤‡
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

---

## ğŸ”§ å·¥å…·é…ç½®å’Œç»´æŠ¤

### Jenkins æ’ä»¶æ¸…å•
```
# å¿…éœ€æ’ä»¶
Pipeline
Git
Docker Pipeline
SonarQube Scanner
JaCoCo
HTML Publisher
Email Extension
Slack Notification
OWASP Dependency-Check

# æ¨èæ’ä»¶
Blue Ocean
Build Monitor View
Dashboard View
Timestamper
Workspace Cleanup
```

### SonarQube ç»´æŠ¤
```bash
# å®šæœŸæ¸…ç†æ—§æ•°æ®
curl -u admin:admin -X POST "http://sonarqube:9000/api/projects/bulk_delete?projects=old-project"

# æ›´æ–°è´¨é‡è§„åˆ™
curl -u admin:admin -X POST "http://sonarqube:9000/api/qualityprofiles/restore" \
  -F backup=@quality-profile.xml

# å¤‡ä»½é…ç½®
curl -u admin:admin "http://sonarqube:9000/api/qualityprofiles/backup?qualityProfile=PowerTrading%20Java%20Rules" \
  > quality-profile-backup.xml
```

---

## ğŸ“Š è´¨é‡åº¦é‡å’ŒæŠ¥å‘Š

### æ¯æ—¥è´¨é‡æŠ¥å‘Š
```python
#!/usr/bin/env python3
# daily-quality-report.py

import requests
import json
from datetime import datetime

def generate_quality_report():
    # è·å–SonarQubeæŒ‡æ ‡
    sonar_metrics = get_sonar_metrics()
    
    # è·å–Jenkinsæ„å»ºçŠ¶æ€
    jenkins_status = get_jenkins_status()
    
    # ç”ŸæˆæŠ¥å‘Š
    report = {
        'date': datetime.now().isoformat(),
        'code_quality': sonar_metrics,
        'build_status': jenkins_status,
        'recommendations': generate_recommendations(sonar_metrics)
    }
    
    # å‘é€æŠ¥å‘Š
    send_report(report)

if __name__ == '__main__':
    generate_quality_report()
```

### å‘¨åº¦è´¨é‡è¶‹åŠ¿åˆ†æ
```sql
-- ä»£ç è´¨é‡è¶‹åŠ¿æŸ¥è¯¢
SELECT 
    DATE(created_at) as date,
    AVG(coverage) as avg_coverage,
    AVG(duplicated_lines_density) as avg_duplication,
    COUNT(CASE WHEN severity = 'CRITICAL' THEN 1 END) as critical_issues,
    COUNT(CASE WHEN severity = 'MAJOR' THEN 1 END) as major_issues
FROM sonar_measures 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at)
ORDER BY date;
```

---

## ğŸ¯ æŒç»­æ”¹è¿›è®¡åˆ’

### çŸ­æœŸç›®æ ‡ (1ä¸ªæœˆ)
1. å»ºç«‹å®Œæ•´çš„CI/CDæµæ°´çº¿
2. å®ç°è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥
3. é…ç½®ç›‘æ§å‘Šè­¦
4. åŸ¹è®­å¼€å‘å›¢é˜Ÿ

### ä¸­æœŸç›®æ ‡ (3ä¸ªæœˆ)
1. ä¼˜åŒ–æµ‹è¯•è¦†ç›–ç‡åˆ°90%
2. å®ç°é›¶å®‰å…¨æ¼æ´
3. å»ºç«‹æ€§èƒ½åŸºå‡†
4. å®Œå–„æ–‡æ¡£å’Œæµç¨‹

### é•¿æœŸç›®æ ‡ (6ä¸ªæœˆ)
1. å®ç°å…¨è‡ªåŠ¨åŒ–éƒ¨ç½²
2. å»ºç«‹è´¨é‡æ–‡åŒ–
3. æŒç»­æ€§èƒ½ä¼˜åŒ–
4. æŠ€æœ¯å€ºåŠ¡æ¸…é›¶

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æµç¨‹å°†æ ¹æ®é¡¹ç›®å‘å±•å’Œå›¢é˜Ÿåé¦ˆæŒç»­ä¼˜åŒ–å’Œå®Œå–„ã€‚*