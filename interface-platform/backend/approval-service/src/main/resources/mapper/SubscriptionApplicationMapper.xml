<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.powertrading.approval.mapper.SubscriptionApplicationMapper">

    <!-- 分页查询申请列表 -->
    <select id="selectApplicationPage" resultType="com.powertrading.approval.entity.SubscriptionApplication">
        SELECT * FROM subscription_applications
        WHERE 1=1
        <if test="userId != null and userId != ''">
            AND user_id = #{userId}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="startTime != null">
            AND submit_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND submit_time <![CDATA[<=]]> #{endTime}
        </if>
        ORDER BY submit_time DESC
    </select>

    <!-- 根据用户ID和接口ID查询是否已存在申请 -->
    <select id="selectExistingApplications" resultType="com.powertrading.approval.entity.SubscriptionApplication">
        SELECT * FROM subscription_applications
        WHERE user_id = #{userId}
        AND status IN ('pending', 'approved')
        AND JSON_OVERLAPS(interface_ids, #{interfaceIds})
    </select>

    <!-- 统计申请数量 -->
    <select id="selectApplicationStatistics" resultType="java.util.Map">
        SELECT
        COUNT(*) as total,
        SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
        SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved,
        SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejected
        FROM subscription_applications
        WHERE 1=1
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="startTime != null">
            AND submit_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND submit_time <![CDATA[<=]]> #{endTime}
        </if>
    </select>

    <!-- 批量更新申请状态 -->
    <update id="batchUpdateStatus">
        UPDATE subscription_applications SET
        status = #{status},
        process_by = #{processBy},
        process_comment = #{processComment},
        process_time = #{processTime},
        update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>