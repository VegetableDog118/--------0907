# ç”µåŠ›äº¤æ˜“ä¸­å¿ƒæ¥å£æœåŠ¡å¹³å°æŠ€æœ¯æ¶æ„æ–‡æ¡£ v1.0

## ç‰ˆæœ¬ä¿¡æ¯

| ç‰ˆæœ¬å· | å‘å¸ƒæ—¥æœŸ   | æ›´æ–°å†…å®¹                           | ç»´æŠ¤äººå‘˜ |
| ------ | ---------- | ---------------------------------- | -------- |
| v1.0   | 2024-01-15 | åˆå§‹æŠ€æœ¯æ¶æ„è®¾è®¡ï¼Œå¯¹åº”PRD v1.0åŠŸèƒ½ | æŠ€æœ¯å›¢é˜Ÿ |

## ç‰ˆæœ¬å¯¹åº”å…³ç³»

**æŠ€æœ¯æ¶æ„ v1.0 å¯¹åº” PRD v1.0**ï¼š

* âœ… æ¥å£ç›®å½•æµè§ˆä¸è®¢é˜…æŠ€æœ¯å®ç°

* âœ… æ¥å£ç”Ÿæˆä¸ç®¡ç†æŠ€æœ¯æ¶æ„

* âœ… è®¢é˜…ç”³è¯·å®¡æ‰¹æŠ€æœ¯æµç¨‹

* âœ… ç”¨æˆ·ä¸­å¿ƒæŠ€æœ¯å®ç°

* ğŸš« æ¥å£ç›‘æ§æŠ€æœ¯æ¶æ„ï¼ˆv2.0å®ç°ï¼‰

* ğŸš« æ—¥å¿—å®¡è®¡æŠ€æœ¯æ–¹æ¡ˆï¼ˆv2.0å®ç°ï¼‰

* ğŸš« è®¡è´¹ç®¡ç†æŠ€æœ¯æ–¹æ¡ˆï¼ˆæš‚ä¸å®ç°ï¼‰

***

## 1. æ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Nginxè´Ÿè½½å‡è¡¡]
    B --> C[Spring Cloud Gateway]
    C --> D[å‰ç«¯åº”ç”¨ Vue.js]
    C --> E[ç”¨æˆ·æœåŠ¡]
    C --> F[æ¥å£ç®¡ç†æœåŠ¡]
    C --> G[å®¡æ‰¹æœåŠ¡]
    
    E --> J[MySQLä¸»åº“]
    F --> J
    G --> J
    
    subgraph "å‰ç«¯å±‚"
        D
    end
    
    subgraph "ç½‘å…³å±‚"
        C
    end
    
    subgraph "åº”ç”¨å±‚"
        E
        F
        G
    end
    
    subgraph "æ•°æ®å±‚"
        J
    end
```

### 1.2 æ¶æ„ç‰¹ç‚¹

* **å¾®æœåŠ¡æ¶æ„**ï¼šé‡‡ç”¨Spring Cloudå¾®æœåŠ¡æ¶æ„ï¼ŒæœåŠ¡é—´é€šè¿‡HTTP REST APIé€šä¿¡

* **å‰åç«¯åˆ†ç¦»**ï¼šVue.jså‰ç«¯ + Spring Bootåç«¯ï¼Œé€šè¿‡RESTful APIäº¤äº’

* **ç»Ÿä¸€ç½‘å…³**ï¼šSpring Cloud Gatewayä½œä¸ºç»Ÿä¸€å…¥å£ï¼Œå¤„ç†è·¯ç”±ã€è®¤è¯ã€é™æµ

* **è¯»å†™åˆ†ç¦»**ï¼šMySQLä¸»ä»æ¶æ„ï¼Œè¯»å†™åˆ†ç¦»æå‡æ•°æ®åº“æ€§èƒ½

## 2. æŠ€æœ¯æ ˆè¯´æ˜

### 2.1 å‰ç«¯æŠ€æœ¯æ ˆ

* **æ¡†æ¶**ï¼šVue.js 3.x + Vue Router + Vuex

* **UIç»„ä»¶åº“**ï¼šElement Plus

* **æ„å»ºå·¥å…·**ï¼šVite

* **æ ·å¼**ï¼šSCSS + CSS3

* **HTTPå®¢æˆ·ç«¯**ï¼šAxios

* **å›¾è¡¨åº“**ï¼šECharts

### 2.2 åç«¯æŠ€æœ¯æ ˆ

* **æ¡†æ¶**ï¼šSpring Boot 2.7.x + Spring Cloud 2021.x

* **ç½‘å…³**ï¼šSpring Cloud Gateway

* **æœåŠ¡æ³¨å†Œ**ï¼šNacos

* **é…ç½®ä¸­å¿ƒ**ï¼šNacos Config

* **æ•°æ®åº“**ï¼šMySQL 8.0ï¼ˆä¸»ä»æ¶æ„ï¼‰

* **æ•°æ®åº“è¿æ¥æ± **ï¼šHikariCPè¿æ¥æ± 

* **ORMæ¡†æ¶**ï¼šMyBatis Plus

* **å®‰å…¨æ¡†æ¶**ï¼šSpring Security + JWT

### 2.3 è¿ç»´æŠ€æœ¯æ ˆ

* **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose

* **ç›‘æ§**ï¼šPrometheus + Grafana

* **æ—¥å¿—**ï¼šELK Stackï¼ˆElasticsearch + Logstash + Kibanaï¼‰

* **è´Ÿè½½å‡è¡¡**ï¼šNginx

## 3. è·¯ç”±å®šä¹‰

### 3.1 å‰ç«¯è·¯ç”±

| è·¯ç”±è·¯å¾„              | ç»„ä»¶åç§°            | åŠŸèƒ½æè¿°   | æƒé™è¦æ±‚      |
| --------------------- | ------------------- | ---------- | ------------- |
| /                     | Dashboard           | é¦–é¡µä»ªè¡¨æ¿ | å·²ç™»å½•        |
| /login                | Login               | ç”¨æˆ·ç™»å½•   | æ—             |
| /interface/catalog    | InterfaceCatalog    | æ¥å£ç›®å½•   | æ‰€æœ‰ç”¨æˆ·      |
| /interface/management | InterfaceManagement | æ¥å£ç®¡ç†   | æŠ€æœ¯éƒ¨/ç»“ç®—éƒ¨ |
| /interface/detail/:id | InterfaceDetail     | æ¥å£è¯¦æƒ…   | æ‰€æœ‰ç”¨æˆ·      |
| /application/approval | ApplicationApproval | ç”³è¯·å®¡æ‰¹   | ç»“ç®—éƒ¨        |
| /user/center          | UserCenter          | ç”¨æˆ·ä¸­å¿ƒ   | æ‰€æœ‰ç”¨æˆ·      |

### 3.2 åç«¯APIè·¯ç”±

| æœåŠ¡åç§°          | è·¯ç”±å‰ç¼€             | åŠŸèƒ½æè¿°     |
| ----------------- | -------------------- | ------------ |
| user-service      | /api/v1/users        | ç”¨æˆ·ç®¡ç†æœåŠ¡ |
| interface-service | /api/v1/interfaces   | æ¥å£ç®¡ç†æœåŠ¡ |
| approval-service  | /api/v1/applications | å®¡æ‰¹æœåŠ¡     |
| gateway-service   | /api/v1/gateway      | ç½‘å…³ç®¡ç†æœåŠ¡ |

## 4. æ ¸å¿ƒä¸šåŠ¡æŠ€æœ¯æ—¶åºå›¾

### 4.1 ç”¨æˆ·ç™»å½•è®¤è¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æµè§ˆå™¨
    participant G as Gatewayç½‘å…³
    participant US as ç”¨æˆ·æœåŠ¡
    participant DB as MySQLæ•°æ®åº“
    
    U->>G: 1. æäº¤ç™»å½•è¯·æ±‚
    G->>US: 2. è½¬å‘ç™»å½•è¯·æ±‚
    US->>DB: 3. éªŒè¯ç”¨æˆ·å‡­æ®
    DB-->>US: 4. è¿”å›ç”¨æˆ·ä¿¡æ¯
    US->>US: 5. ç”ŸæˆJWT Token
    US->>DB: 6. ä¿å­˜ç”¨æˆ·ä¼šè¯
    US-->>G: 7. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
    G-->>U: 8. è¿”å›ç™»å½•ç»“æœ
    
    Note over U,DB: åç»­è¯·æ±‚æºå¸¦Tokenè¿›è¡Œè®¤è¯
    U->>G: 9. æºå¸¦Tokençš„APIè¯·æ±‚
    G->>G: 10. éªŒè¯Tokenæœ‰æ•ˆæ€§
    G->>DB: 11. æ£€æŸ¥Tokenæœ‰æ•ˆæ€§
    DB-->>G: 12. è¿”å›éªŒè¯ç»“æœ
    G->>US: 13. è½¬å‘ä¸šåŠ¡è¯·æ±‚
    US-->>G: 14. è¿”å›ä¸šåŠ¡ç»“æœ
    G-->>U: 15. è¿”å›æœ€ç»ˆç»“æœ
```

### 4.2 ç»Ÿä¸€æ¥å£é…ç½®è§„èŒƒå®ç°

#### 4.2.1 æ¥å£è·¯å¾„è§„èŒƒåŒ–

**è·¯å¾„ç”Ÿæˆè§„åˆ™**ï¼š

```java
@Service
public class InterfacePathGenerator {
    
    private static final String PATH_PREFIX = "/px-phzhb-external-share/dataproduct/";
    
    public String generateInterfacePath(String interfaceName, String businessType) {
        // æ ¹æ®æ¥å£åç§°å’Œä¸šåŠ¡ç±»å‹ç”Ÿæˆæ ‡å‡†è·¯å¾„
        String pathSuffix = generatePathSuffix(interfaceName, businessType);
        return PATH_PREFIX + pathSuffix;
    }
    
    private String generatePathSuffix(String interfaceName, String businessType) {
        // ç¤ºä¾‹ï¼š"ç”µç½‘å…³é”®æ–­é¢çº¦æŸæƒ…å†µ" -> "queryKeySectionConstraints"
        // ç¤ºä¾‹ï¼š"å¿…å¼€å¿…åœæœºç»„åå•" -> "queryMustOpenOffNameAndCapacity"
        return convertToApiPath(interfaceName);
    }
}
```

#### 4.2.2 æ ‡å‡†å‚æ•°æ¨¡æ¿

**å‚æ•°é…ç½®æ¨¡æ¿**ï¼š

```java
@Component
public class StandardParameterTemplate {
    
    public List<ParameterDefinition> getStandardParameters() {
        return Arrays.asList(
            ParameterDefinition.builder()
                .paramName("dataTime")
                .paramType("string")
                .description("æŸ¥è¯¢æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD")
                .required(true)
                .validationRule("date:YYYY-MM-DD,max:yesterday")
                .example("2022-03-17")
                .build(),
            ParameterDefinition.builder()
                .paramName("appId")
                .paramType("string")
                .description("åº”ç”¨IDï¼Œç”¨æˆ·èº«ä»½æ ‡è¯†")
                .required(true)
                .validationRule("string,length:15-20")
                .example("KzoHypQZH4-F6qM63L")
                .build()
        );
    }
}
```

### 4.3 æ¥å£ç”Ÿæˆå®Œæ•´æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as æŠ€æœ¯äººå‘˜
    participant F as å‰ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant IS as æ¥å£æœåŠ¡
    participant DB as MySQLæ•°æ®åº“
    
    U->>F: 1. ç‚¹å‡»ç”Ÿæˆæ¥å£æŒ‰é’®
    F->>G: 2. è¯·æ±‚æ•°æ®åº“è¡¨åˆ—è¡¨
    G->>IS: 3. è½¬å‘è¯·æ±‚
    IS->>DB: 4. æŸ¥è¯¢æ•°æ®åº“è¡¨ä¿¡æ¯
    DB-->>IS: 5. è¿”å›è¡¨åˆ—è¡¨
    IS-->>G: 6. è¿”å›è¡¨åˆ—è¡¨
    G-->>F: 7. è¿”å›ç»™å‰ç«¯
    F-->>U: 8. å±•ç¤ºæ•°æ®åº“è¡¨é€‰æ‹©ç•Œé¢
    
    U->>F: 9. é€‰æ‹©æ•°æ®åº“è¡¨å¹¶é…ç½®æ¥å£
    F->>G: 10. æäº¤æ¥å£ç”Ÿæˆè¯·æ±‚
    G->>IS: 11. è½¬å‘ç”Ÿæˆè¯·æ±‚
    IS->>DB: 12. éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
    DB-->>IS: 13. è¿”å›è¡¨ç»“æ„ä¿¡æ¯
    IS->>IS: 14. ç”Ÿæˆæ¥å£ä»£ç å’Œé…ç½®
    IS->>DB: 15. ä¿å­˜æ¥å£ä¿¡æ¯(çŠ¶æ€ä¸ºæœªä¸Šæ¶)
    IS-->>G: 16. è¿”å›ç”Ÿæˆç»“æœ
    G-->>F: 17. è¿”å›ç»™å‰ç«¯
    F-->>U: 18. æ˜¾ç¤ºæ¥å£ç”ŸæˆæˆåŠŸï¼Œè¿›å…¥æœªä¸Šæ¶åˆ—è¡¨
    
    Note over IS: æ¥å£ç”Ÿæˆå®Œæˆï¼Œç­‰å¾…ç»“ç®—éƒ¨ä¸Šæ¶
```

### 4.4 æ¥å£ä¸Šæ¶æ“ä½œæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant B as ç»“ç®—äººå‘˜
    participant F as å‰ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant IS as æ¥å£æœåŠ¡
    participant GS as ç½‘å…³æœåŠ¡
    participant DB as MySQLæ•°æ®åº“
    
    B->>F: 1. æŸ¥çœ‹æœªä¸Šæ¶æ¥å£åˆ—è¡¨
    F->>G: 2. è¯·æ±‚æœªä¸Šæ¶æ¥å£
    G->>IS: 3. è½¬å‘è¯·æ±‚
    IS->>DB: 4. æŸ¥è¯¢æœªä¸Šæ¶æ¥å£
    DB-->>IS: 5. è¿”å›æ¥å£åˆ—è¡¨
    IS-->>G: 6. è¿”å›æ¥å£æ•°æ®
    G-->>F: 7. è¿”å›ç»™å‰ç«¯
    F-->>B: 8. å±•ç¤ºæœªä¸Šæ¶æ¥å£åˆ—è¡¨
    
    B->>F: 9. é€‰æ‹©æ¥å£å¹¶ç‚¹å‡»ä¸Šæ¶
    F->>G: 10. å‘é€ä¸Šæ¶è¯·æ±‚
    G->>IS: 11. è½¬å‘ä¸Šæ¶è¯·æ±‚
    IS->>DB: 12. æ›´æ–°æ¥å£çŠ¶æ€ä¸ºå·²ä¸Šæ¶
    IS->>GS: 13. åŒæ­¥è°ƒç”¨ç½‘å…³æœåŠ¡æ³¨å†Œè·¯ç”±
    GS->>GS: 14. ç”ŸæˆåŠ¨æ€è·¯ç”±é…ç½®
    GS->>G: 15. æ³¨å†Œæ¥å£è·¯ç”±
    GS-->>IS: 16. è¿”å›è·¯ç”±æ³¨å†Œç»“æœ
    IS-->>G: 17. è¿”å›ä¸Šæ¶ç»“æœ
    G-->>F: 18. è¿”å›ç»™å‰ç«¯
    F-->>B: 19. æ˜¾ç¤ºä¸Šæ¶æˆåŠŸ
    
    Note over IS,GS: åŒæ­¥å¤„ç†è·¯ç”±æ³¨å†Œï¼Œç¡®ä¿æ“ä½œä¸€è‡´æ€§
```

### 4.5 è®¢é˜…ç”³è¯·å®¡æ‰¹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant C as æ•°æ®æ¶ˆè´¹è€…
    participant F as å‰ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant AS as å®¡æ‰¹æœåŠ¡
    participant US as ç”¨æˆ·æœåŠ¡
    participant NS as é€šçŸ¥æœåŠ¡
    participant DB as MySQLæ•°æ®åº“
    participant A as å®¡æ‰¹äººå‘˜
    
    C->>F: 1. æäº¤è®¢é˜…ç”³è¯·
    F->>G: 2. å‘é€ç”³è¯·è¯·æ±‚
    G->>AS: 3. è½¬å‘åˆ°å®¡æ‰¹æœåŠ¡
    AS->>DB: 4. ä¿å­˜ç”³è¯·è®°å½•
    AS->>NS: 5. å‘é€å®¡æ‰¹é€šçŸ¥
    NS->>A: 6. é€šçŸ¥å®¡æ‰¹äººå‘˜
    AS-->>G: 7. è¿”å›ç”³è¯·ç»“æœ
    G-->>F: 8. è¿”å›ç»™å‰ç«¯
    F-->>C: 9. æ˜¾ç¤ºç”³è¯·æäº¤æˆåŠŸ
    
    Note over A: å®¡æ‰¹äººå‘˜å¤„ç†ç”³è¯·
    A->>F: 10. æŸ¥çœ‹ç”³è¯·è¯¦æƒ…
    F->>G: 11. è¯·æ±‚ç”³è¯·ä¿¡æ¯
    G->>AS: 12. è½¬å‘è¯·æ±‚
    AS->>DB: 13. æŸ¥è¯¢ç”³è¯·è¯¦æƒ…
    DB-->>AS: 14. è¿”å›ç”³è¯·ä¿¡æ¯
    AS-->>G: 15. è¿”å›ç”³è¯·è¯¦æƒ…
    G-->>F: 16. è¿”å›ç»™å‰ç«¯
    F-->>A: 17. å±•ç¤ºç”³è¯·è¯¦æƒ…
    
    A->>F: 18. æäº¤å®¡æ‰¹å†³å®š
    F->>G: 19. å‘é€å®¡æ‰¹ç»“æœ
    G->>AS: 20. è½¬å‘å®¡æ‰¹è¯·æ±‚
    AS->>DB: 21. æ›´æ–°ç”³è¯·çŠ¶æ€
    AS->>US: 22. æ›´æ–°ç”¨æˆ·æƒé™
    US->>DB: 23. ä¿å­˜æƒé™å˜æ›´
    AS->>NS: 24. å‘é€ç»“æœé€šçŸ¥
    NS->>C: 25. é€šçŸ¥ç”³è¯·äºº
    AS-->>G: 26. è¿”å›å¤„ç†ç»“æœ
    G-->>F: 27. è¿”å›ç»™å‰ç«¯
    F-->>A: 28. æ˜¾ç¤ºå¤„ç†æˆåŠŸ
```

### 4.6 APIè°ƒç”¨è®¤è¯æ—¶åºå›¾ï¼ˆappIdéªŒè¯ï¼‰

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant AS as è®¤è¯æœåŠ¡
    participant IS as æ¥å£æœåŠ¡
    participant DS as æ•°æ®æº
    participant AL as å®¡è®¡æ—¥å¿—
    participant DB as MySQLæ•°æ®åº“
    
    C->>G: 1. APIè°ƒç”¨è¯·æ±‚(POST, JSONæ ¼å¼, åŒ…å«appId)
    G->>AS: 2. éªŒè¯appId
    AS->>DB: 3. æŸ¥è¯¢appIdå’Œæƒé™
    DB-->>AS: 4. è¿”å›ç”¨æˆ·æƒé™ä¿¡æ¯
    
    AS->>AS: 5. éªŒè¯æ¥å£è®¿é—®æƒé™
    alt æƒé™éªŒè¯é€šè¿‡
        AS-->>G: 6a. è¿”å›è®¤è¯æˆåŠŸ
        G->>IS: 7a. è½¬å‘ä¸šåŠ¡è¯·æ±‚
        IS->>DB: 8a. æ‰§è¡ŒSQLæŸ¥è¯¢
        DB-->>IS: 9a. è¿”å›æ ‡å‡†æ ¼å¼æ•°æ®
        IS->>IS: 10a. æ ¼å¼åŒ–ä¸º{status, message, data}å“åº”
        IS->>AL: 11a. è®°å½•è°ƒç”¨æ—¥å¿—
        IS-->>G: 12a. è¿”å›æ ‡å‡†å“åº”
        G-->>C: 13a. è¿”å›APIç»“æœ
    else æƒé™éªŒè¯å¤±è´¥
        AS->>AL: 6b. è®°å½•è®¿é—®æ‹’ç»æ—¥å¿—
        AS-->>G: 7b. è¿”å›æƒé™é”™è¯¯
        G-->>C: 8b. è¿”å›æ ‡å‡†é”™è¯¯å“åº”
    end
```

### 4.7 åŸAPIè°ƒç”¨è®¤è¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant AS as è®¤è¯æœåŠ¡
    participant IS as æ¥å£æœåŠ¡
    participant DS as æ•°æ®æº
    participant AL as å®¡è®¡æ—¥å¿—
    participant DB as MySQLæ•°æ®åº“
    
    C->>G: 1. APIè°ƒç”¨è¯·æ±‚(æºå¸¦API Key)
    G->>AS: 2. éªŒè¯API Key
    AS->>DB: 3. æŸ¥è¯¢Keyå’Œæƒé™
    DB-->>AS: 4. è¿”å›æƒé™ä¿¡æ¯
    
    AS->>AS: 5. éªŒè¯æ¥å£è®¿é—®æƒé™
    alt æƒé™éªŒè¯é€šè¿‡
        AS-->>G: 6a. è¿”å›è®¤è¯æˆåŠŸ
        G->>IS: 7a. è½¬å‘ä¸šåŠ¡è¯·æ±‚
        IS->>DB: 8a. æŸ¥è¯¢MySQLæ•°æ®åº“
    DB-->>IS: 9a. è¿”å›æ•°æ®
        IS->>AL: 10a. è®°å½•è°ƒç”¨æ—¥å¿—
        IS-->>G: 11a. è¿”å›ä¸šåŠ¡æ•°æ®
        G-->>C: 12a. è¿”å›APIç»“æœ
    else æƒé™éªŒè¯å¤±è´¥
        AS->>AL: 6b. è®°å½•è®¿é—®æ‹’ç»æ—¥å¿—
        AS-->>G: 7b. è¿”å›æƒé™é”™è¯¯
        G-->>C: 8b. è¿”å›403é”™è¯¯
    end
```

## 5. ç½‘å…³ä¸è·¯ç”±ç»´æŠ¤ç­–ç•¥

### 5.1 Spring Cloud GatewayåŠ¨æ€è·¯ç”±æ¶æ„

```mermaid
graph TD
    A[Gatewayå¯åŠ¨] --> B[åŠ è½½é™æ€è·¯ç”±é…ç½®]
    B --> C[è¿æ¥Nacosé…ç½®ä¸­å¿ƒ]
    C --> D[ç›‘å¬è·¯ç”±é…ç½®å˜æ›´]
    D --> E[åŠ¨æ€è·¯ç”±ç®¡ç†å™¨]
    
    E --> F[è·¯ç”±æ³¨å†Œ]
    E --> G[è·¯ç”±æ›´æ–°]
    E --> H[è·¯ç”±åˆ é™¤]
    
    F --> I[æ›´æ–°è·¯ç”±è¡¨]
    G --> I
    H --> I
    
    I --> J[åˆ·æ–°Gatewayè·¯ç”±]
    J --> K[é€šçŸ¥å…¶ä»–Gatewayå®ä¾‹]
    
    subgraph "è·¯ç”±å­˜å‚¨"
        L[Nacosé…ç½®]
        N[æœ¬åœ°ç¼“å­˜]
    end
    
    E --> L
    E --> N
```

### 5.2 åŠ¨æ€è·¯ç”±é…ç½®è§„èŒƒ

#### 5.2.1 è·¯ç”±é…ç½®æ ¼å¼

```yaml
# æ¥å£è·¯ç”±é…ç½®ç¤ºä¾‹
spring:
  cloud:
    gateway:
      routes:
        - id: interface-route-{interfaceId}
          uri: lb://interface-service
          predicates:
            - Path=/api/data/{interfaceId}/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
            - name: AuthFilter
              args:
                required-permissions: interface:read
          metadata:
            interface-id: "{interfaceId}"
            created-by: "system"
            created-time: "2024-01-15T10:30:00Z"
```

#### 5.2.2 è·¯ç”±ç®¡ç†API

```java
@RestController
@RequestMapping("/api/v1/gateway/routes")
public class RouteController {
    
    @PostMapping
    public ResponseEntity<String> addRoute(@RequestBody RouteDefinition route) {
        // æ·»åŠ åŠ¨æ€è·¯ç”±
        routeService.addRoute(route);
        return ResponseEntity.ok("Route added successfully");
    }
    
    @PutMapping("/{routeId}")
    public ResponseEntity<String> updateRoute(
        @PathVariable String routeId, 
        @RequestBody RouteDefinition route) {
        // æ›´æ–°è·¯ç”±é…ç½®
        routeService.updateRoute(routeId, route);
        return ResponseEntity.ok("Route updated successfully");
    }
    
    @DeleteMapping("/{routeId}")
    public ResponseEntity<String> deleteRoute(@PathVariable String routeId) {
        // åˆ é™¤è·¯ç”±
        routeService.deleteRoute(routeId);
        return ResponseEntity.ok("Route deleted successfully");
    }
}
```

### 5.3 è·¯ç”±çƒ­æ›´æ–°æœºåˆ¶

#### 5.3.1 é…ç½®å˜æ›´ç›‘å¬

```java
@Component
public class RouteConfigListener {
    
    @NacosConfigListener(dataId = "gateway-routes", groupId = "DEFAULT_GROUP")
    public void onRouteConfigChange(String configInfo) {
        try {
            // è§£ææ–°çš„è·¯ç”±é…ç½®
            List<RouteDefinition> newRoutes = parseRouteConfig(configInfo);
            
            // æ›´æ–°è·¯ç”±è¡¨
            routeDefinitionRepository.save(newRoutes);
            
            // åˆ·æ–°Gatewayè·¯ç”±
            applicationEventPublisher.publishEvent(new RefreshRoutesEvent(this));
            
            log.info("Route configuration updated successfully");
        } catch (Exception e) {
            log.error("Failed to update route configuration", e);
        }
    }
}
```

#### 5.3.2 ç°åº¦å‘å¸ƒç­–ç•¥

```java
@Service
public class GrayReleaseService {
    
    public void enableGrayRelease(String interfaceId, String version, int percentage) {
        // åˆ›å»ºç°åº¦è·¯ç”±è§„åˆ™
        RouteDefinition grayRoute = RouteDefinition.builder()
            .id("gray-" + interfaceId + "-" + version)
            .uri("lb://interface-service-" + version)
            .predicate(predicateDefinition -> {
                predicateDefinition.setName("Path");
                predicateDefinition.addArg("pattern", "/api/data/" + interfaceId + "/**");
            })
            .filter(filterDefinition -> {
                filterDefinition.setName("GrayReleaseFilter");
                filterDefinition.addArg("percentage", String.valueOf(percentage));
            })
            .build();
            
        // æ³¨å†Œç°åº¦è·¯ç”±
        routeDefinitionRepository.save(grayRoute);
        
        // å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶
        applicationEventPublisher.publishEvent(new RefreshRoutesEvent(this));
    }
}
```

### 5.4 è·¯ç”±ç›‘æ§ä¸å‘Šè­¦

#### 5.4.1 è·¯ç”±å¥åº·æ£€æŸ¥

```java
@Component
@Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
public class RouteHealthChecker {
    
    public void checkRouteHealth() {
        List<RouteDefinition> routes = routeDefinitionRepository.getRouteDefinitions();
        
        for (RouteDefinition route : routes) {
            try {
                // æ£€æŸ¥è·¯ç”±ç›®æ ‡æœåŠ¡å¥åº·çŠ¶æ€
                boolean isHealthy = checkServiceHealth(route.getUri());
                
                if (!isHealthy) {
                    // å‘é€å‘Šè­¦
                    alertService.sendAlert(
                        "Route Health Check Failed", 
                        "Route " + route.getId() + " target service is unhealthy"
                    );
                    
                    // å¯é€‰ï¼šè‡ªåŠ¨ç¦ç”¨ä¸å¥åº·çš„è·¯ç”±
                    // routeService.disableRoute(route.getId());
                }
            } catch (Exception e) {
                log.error("Health check failed for route: " + route.getId(), e);
            }
        }
    }
}
```

## 6. æ•°æ®æ¨¡å‹è®¾è®¡

### 6.1 è¡¨çº§æ¨¡å‹ - ERå›¾

```mermaid
erDiagram
    USERS ||--o{ USER_ROLES : has
    USER_ROLES }o--|| ROLES : belongs_to
    USERS ||--o{ API_KEYS : owns
    USERS ||--o{ SUBSCRIPTION_APPLICATIONS : submits
    
    INTERFACES ||--o{ SUBSCRIPTION_APPLICATIONS : receives

    INTERFACES ||--o{ INTERFACE_PARAMETERS : has
    INTERFACES ||--o{ API_CALL_LOGS : generates
    
    SUBSCRIPTION_APPLICATIONS ||--o{ APPROVAL_RECORDS : has
    APPROVAL_RECORDS }o--|| USERS : approved_by
    
    API_KEYS ||--o{ API_CALL_LOGS : authenticates
    
    USERS {
        bigint id PK
        varchar username UK
        varchar email UK
        varchar password_hash
        varchar real_name
        varchar phone
        varchar department
        varchar position
        tinyint status
        datetime created_at
        datetime updated_at
    }
    
    ROLES {
        int id PK
        varchar role_name UK
        varchar role_code UK
        varchar description
        json permissions
        tinyint status
        datetime created_at
    }
    
    USER_ROLES {
        bigint id PK
        bigint user_id FK
        int role_id FK
        datetime assigned_at
    }
    
    API_KEYS {
        bigint id PK
        bigint user_id FK
        varchar api_key UK
        varchar secret_key
        json permissions
        datetime expires_at
        tinyint status
        datetime created_at
        datetime last_used_at
    }
    

    
    INTERFACES {
        bigint id PK
        varchar interface_name
        varchar interface_path UK
        varchar description

        varchar sql_template
        json request_params
        json response_format
        varchar status
        bigint created_by FK
        datetime created_at
        datetime updated_at
        datetime published_at
    }
    
    INTERFACE_PARAMETERS {
        bigint id PK
        bigint interface_id FK
        varchar param_name
        varchar param_type
        varchar param_description
        tinyint is_required
        varchar default_value
        varchar validation_rule
        int sort_order
    }
    
    SUBSCRIPTION_APPLICATIONS {
        bigint id PK
        bigint user_id FK
        bigint interface_id FK
        varchar application_reason
        varchar business_scenario
        varchar status
        datetime applied_at
        datetime approved_at
        bigint approved_by FK
        varchar approval_comment
    }
    
    APPROVAL_RECORDS {
        bigint id PK
        bigint application_id FK
        bigint approver_id FK
        varchar action
        varchar comment
        datetime created_at
    }
    
    API_CALL_LOGS {
        bigint id PK
        bigint api_key_id FK
        bigint interface_id FK
        varchar request_ip
        varchar request_method
        text request_params
        int response_status
        text response_body
        int response_time_ms
        datetime created_at
    }
    
    OPERATION_LOGS {
        bigint id PK
        bigint user_id FK
        varchar operation_type
        varchar operation_desc
        varchar target_type
        varchar target_id
        json operation_data
        varchar request_ip
        varchar user_agent
        datetime created_at
    }
```

### 6.2 è¡¨èŒè´£è¯´æ˜

| è¡¨å        | èŒè´£æè¿°         | æ ¸å¿ƒä¸šåŠ¡                       |
| ----------- | ---------------- | ------------------------------ |
| users       | ç”¨æˆ·åŸºç¡€ä¿¡æ¯ç®¡ç† | å­˜å‚¨ç”¨æˆ·è´¦å·ã€ä¸ªäººä¿¡æ¯ã€çŠ¶æ€ç­‰ |
| roles       | è§’è‰²æƒé™å®šä¹‰     | å®šä¹‰ç³»ç»Ÿè§’è‰²å’Œå¯¹åº”æƒé™         |
| user\_roles | ç”¨æˆ·è§’è‰²å…³è”     | ç®¡ç†ç”¨æˆ·ä¸è§’è‰²çš„å¤šå¯¹å¤šå…³ç³»     |
| api\_keys   | APIå¯†é’¥ç®¡ç†      | ç»Ÿä¸€APIå¯†é’¥ç”Ÿæˆã€æƒé™æ§åˆ¶      |

\| interfaces                 | æ¥å£å®šä¹‰ç®¡ç†   | å­˜å‚¨æ¥å£å…ƒæ•°æ®ã€SQLæ¨¡æ¿ç­‰  |
\| interface\_parameters      | æ¥å£å‚æ•°å®šä¹‰   | å®šä¹‰æ¥å£è¯·æ±‚å‚æ•°è§„èŒƒ      |
\| subscription\_applications | è®¢é˜…ç”³è¯·ç®¡ç†   | å¤„ç†ç”¨æˆ·æ¥å£è®¢é˜…ç”³è¯·æµç¨‹    |
\| approval\_records          | å®¡æ‰¹è®°å½•     | è®°å½•å®¡æ‰¹è¿‡ç¨‹å’Œå†å²       |
\| api\_call\_logs            | APIè°ƒç”¨æ—¥å¿—  | è®°å½•æ‰€æœ‰APIè°ƒç”¨è¯¦æƒ…     |
\| operation\_logs            | æ“ä½œå®¡è®¡æ—¥å¿—   | è®°å½•å¹³å°æ“ä½œè¡Œä¸ºå®¡è®¡      |

### 6.3 MySQLæ•°æ®åº“è¿æ¥é…ç½®

#### 6.3.1 æ•°æ®åº“è¿æ¥é…ç½®

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š

```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://mysql-master:3306/power_trading?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=true
    username: ${DB_USERNAME:power_user}
    password: ${DB_PASSWORD:power_password}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      pool-name: PowerTradingHikariCP
      
  # è¯»å†™åˆ†ç¦»é…ç½®
  datasource:
    master:
      url: jdbc:mysql://mysql-master:3306/power_trading
      username: ${DB_MASTER_USERNAME:power_user}
      password: ${DB_MASTER_PASSWORD:power_password}
    slave:
      url: jdbc:mysql://mysql-slave:3306/power_trading
      username: ${DB_SLAVE_USERNAME:power_readonly}
      password: ${DB_SLAVE_PASSWORD:readonly_password}
```

#### 6.3.2 æ¥å£æ•°æ®è®¿é—®æ–¹å¼

**ç»Ÿä¸€æ•°æ®è®¿é—®**ï¼š

* æ‰€æœ‰æ¥å£å‡åŸºäºç°æœ‰MySQLæ•°æ®åº“ä¸­çš„ä¸šåŠ¡è¡¨

* é€šè¿‡SQLæ¨¡æ¿åŠ¨æ€ç”ŸæˆæŸ¥è¯¢è¯­å¥

* æ”¯æŒå‚æ•°åŒ–æŸ¥è¯¢ï¼Œç¡®ä¿æ•°æ®å®‰å…¨

* ç»Ÿä¸€ä½¿ç”¨HikariCPè¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥

**æ•°æ®è¡¨è®¿é—®è§„èŒƒ**ï¼š

* æ¥å£ç”Ÿæˆæ—¶ç›´æ¥é€‰æ‹©MySQLæ•°æ®åº“ä¸­çš„ä¸šåŠ¡è¡¨

* æ”¯æŒå¤šè¡¨å…³è”æŸ¥è¯¢å’Œå¤æ‚ä¸šåŠ¡é€»è¾‘

* è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†åŒ–çš„RESTful APIæ¥å£

* ç»Ÿä¸€çš„æ•°æ®æ ¼å¼å’Œé”™è¯¯å¤„ç†æœºåˆ¶

### 6.4 å­—æ®µçº§æ•°æ®å­—å…¸

#### 6.4.1 æ•æ„Ÿæ•°æ®åˆ†çº§æ ‡å‡†

| æ•æ„Ÿçº§åˆ« | çº§åˆ«æè¿°           | æ•°æ®ç±»å‹ç¤ºä¾‹               | è„±æ•ç­–ç•¥ |
| -------- | ------------------ | -------------------------- | -------- |
| L1-å…¬å¼€  | å¯å…¬å¼€è®¿é—®çš„æ•°æ®   | ç”¨æˆ·åã€æ¥å£åç§°ã€å…¬å¼€æè¿° | æ— éœ€è„±æ• |
| L2-å†…éƒ¨  | å†…éƒ¨ä½¿ç”¨çš„ä¸šåŠ¡æ•°æ® | éƒ¨é—¨ä¿¡æ¯ã€æ¥å£é…ç½®         | éƒ¨åˆ†è„±æ• |
| L3-æ•æ„Ÿ  | ä¸ªäººæ•æ„Ÿä¿¡æ¯       | æ‰‹æœºå·ã€é‚®ç®±ã€çœŸå®å§“å     | ä¸­é—´è„±æ• |
| L4-æœºå¯†  | é«˜åº¦æœºå¯†æ•°æ®       | å¯†ç ã€å¯†é’¥ã€æ•°æ®åº“è¿æ¥     | å®Œå…¨åŠ å¯† |

#### 6.3.2 æ ¸å¿ƒè¡¨å­—æ®µå­—å…¸

**usersè¡¨å­—æ®µè¯¦æƒ…**ï¼š

| å­—æ®µå         | æ•°æ®ç±»å‹ | é•¿åº¦ | æ˜¯å¦å¿…å¡« | æ•æ„Ÿçº§åˆ« | è„±æ•è§„åˆ™    | å­—æ®µæè¿°                |
| -------------- | -------- | ---- | -------- | -------- | ----------- | ----------------------- |
| id             | bigint   | -    | æ˜¯       | L1-å…¬å¼€  | æ—           | ç”¨æˆ·å”¯ä¸€æ ‡è¯†            |
| username       | varchar  | 50   | æ˜¯       | L2-å†…éƒ¨  | æ—           | ç”¨æˆ·ç™»å½•å              |
| email          | varchar  | 100  | æ˜¯       | L3-æ•æ„Ÿ  | ä¸­é—´4ä½\*å· | ç”¨æˆ·é‚®ç®±åœ°å€            |
| password\_hash | varchar  | 255  | æ˜¯       | L4-æœºå¯†  | å®Œå…¨éšè—    | å¯†ç å“ˆå¸Œå€¼              |
| real\_name     | varchar  | 50   | æ˜¯       | L3-æ•æ„Ÿ  | å§“æ°+\*å·   | ç”¨æˆ·çœŸå®å§“å            |
| phone          | varchar  | 20   | å¦       | L3-æ•æ„Ÿ  | ä¸­é—´4ä½\*å· | æ‰‹æœºå·ç                 |
| department     | varchar  | 100  | å¦       | L2-å†…éƒ¨  | æ—           | æ‰€å±éƒ¨é—¨                |
| position       | varchar  | 100  | å¦       | L2-å†…éƒ¨  | æ—           | èŒä½ä¿¡æ¯                |
| status         | tinyint  | -    | æ˜¯       | L1-å…¬å¼€  | æ—           | ç”¨æˆ·çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨) |
| created\_at    | datetime | -    | æ˜¯       | L1-å…¬å¼€  | æ—           | åˆ›å»ºæ—¶é—´                |
| updated\_at    | datetime | -    | æ˜¯       | L1-å…¬å¼€  | æ—           | æ›´æ–°æ—¶é—´                |

**interfacesè¡¨å­—æ®µè¯¦æƒ…**ï¼š

| å­—æ®µå           | æ•°æ®ç±»å‹ | é•¿åº¦ | æ˜¯å¦å¿…å¡« | æ•æ„Ÿçº§åˆ« | è„±æ•è§„åˆ™   | å­—æ®µæè¿°     |
| ---------------- | -------- | ---- | -------- | -------- | ---------- | ------------ |
| id               | bigint   | -    | æ˜¯       | L1-å…¬å¼€  | æ—          | æ¥å£å”¯ä¸€æ ‡è¯† |
| interface\_name  | varchar  | 200  | æ˜¯       | L1-å…¬å¼€  | æ—          | æ¥å£åç§°     |
| interface\_path  | varchar  | 500  | æ˜¯       | L2-å†…éƒ¨  | æ—          | æ¥å£è®¿é—®è·¯å¾„ |
| description      | text     | -    | å¦       | L1-å…¬å¼€  | æ—          | æ¥å£æè¿°ä¿¡æ¯ |
| data\_source\_id | int      | -    | æ˜¯       | L2-å†…éƒ¨  | æ—          | å…³è”æ•°æ®æºID |
| sql\_template    | text     | -    | æ˜¯       | L3-æ•æ„Ÿ  | å…³é”®å­—è„±æ• | SQLæŸ¥è¯¢æ¨¡æ¿  |
| request\_params  | json     | -    | å¦       | L2-å†…éƒ¨  | æ—          | è¯·æ±‚å‚æ•°å®šä¹‰ |
| response\_format | json     | -    | å¦       | L2-å†…éƒ¨  | æ—          | å“åº”æ ¼å¼å®šä¹‰ |
| status           | varchar  | 20   | æ˜¯       | L1-å…¬å¼€  | æ—          | æ¥å£çŠ¶æ€     |
| created\_by      | bigint   | -    | æ˜¯       | L2-å†…éƒ¨  | æ—          | åˆ›å»ºäººID     |
| created\_at      | datetime | -    | æ˜¯       | L1-å…¬å¼€  | æ—          | åˆ›å»ºæ—¶é—´     |
| updated\_at      | datetime | -    | æ˜¯       | L1-å…¬å¼€  | æ—          | æ›´æ–°æ—¶é—´     |
| published\_at    | datetime | -    | å¦       | L1-å…¬å¼€  | æ—          | å‘å¸ƒæ—¶é—´     |

**api\_keysè¡¨å­—æ®µè¯¦æƒ…**ï¼š

| å­—æ®µå         | æ•°æ®ç±»å‹ | é•¿åº¦ | æ˜¯å¦å¿…å¡« | æ•æ„Ÿçº§åˆ« | è„±æ•è§„åˆ™           | å­—æ®µæè¿°     |
| -------------- | -------- | ---- | -------- | -------- | ------------------ | ------------ |
| id             | bigint   | -    | æ˜¯       | L1-å…¬å¼€  | æ—                  | å¯†é’¥è®°å½•ID   |
| user\_id       | bigint   | -    | æ˜¯       | L2-å†…éƒ¨  | æ—                  | å…³è”ç”¨æˆ·ID   |
| api\_key       | varchar  | 64   | æ˜¯       | L4-æœºå¯†  | å‰4ä½+\*\*\*+å4ä½ | APIè®¿é—®å¯†é’¥  |
| secret\_key    | varchar  | 128  | æ˜¯       | L4-æœºå¯†  | å®Œå…¨éšè—           | å¯†é’¥ç­¾åç§˜é’¥ |
| permissions    | json     | -    | å¦       | L2-å†…éƒ¨  | æ—                  | æƒé™èŒƒå›´å®šä¹‰ |
| expires\_at    | datetime | -    | å¦       | L2-å†…éƒ¨  | æ—                  | è¿‡æœŸæ—¶é—´     |
| status         | tinyint  | -    | æ˜¯       | L1-å…¬å¼€  | æ—                  | å¯†é’¥çŠ¶æ€     |
| created\_at    | datetime | -    | æ˜¯       | L1-å…¬å¼€  | æ—                  | åˆ›å»ºæ—¶é—´     |
| last\_used\_at | datetime | -    | å¦       | L2-å†…éƒ¨  | æ—                  | æœ€åä½¿ç”¨æ—¶é—´ |

#### 6.3.3 è„±æ•å®ç°ç­–ç•¥

```java
@Component
public class DataMaskingService {
    
    /**
     * æ‰‹æœºå·è„±æ•ï¼š138****5678
     */
    public String maskPhone(String phone) {
        if (StringUtils.isEmpty(phone) || phone.length() < 7) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(phone.length() - 4);
    }
    
    /**
     * é‚®ç®±è„±æ•ï¼šabc****@example.com
     */
    public String maskEmail(String email) {
        if (StringUtils.isEmpty(email) || !email.contains("@")) {
            return email;
        }
        String[] parts = email.split("@");
        String username = parts[0];
        if (username.length() <= 3) {
            return email;
        }
        return username.substring(0, 3) + "****@" + parts[1];
    }
    
    /**
     * å§“åè„±æ•ï¼šå¼ **
     */
    public String maskName(String name) {
        if (StringUtils.isEmpty(name) || name.length() < 2) {
            return name;
        }
        return name.substring(0, 1) + "*".repeat(name.length() - 1);
    }
    
    /**
     * APIå¯†é’¥è„±æ•ï¼šabcd****wxyz
     */
    public String maskApiKey(String apiKey) {
        if (StringUtils.isEmpty(apiKey) || apiKey.length() < 8) {
            return "****";
        }
        return apiKey.substring(0, 4) + "****" + apiKey.substring(apiKey.length() - 4);
    }
}
```

## 7. åŠŸèƒ½æ¨¡å—è¯¦ç»†è°ƒç”¨è®¾è®¡

### 7.1 æ¥å£ç›®å½•æµè§ˆè°ƒç”¨é“¾è·¯

#### 7.1.1 å‰ç«¯â†’ç½‘å…³â†’åç«¯â†’æ•°æ®åº“è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant F as Vueå‰ç«¯
    participant G as Gatewayç½‘å…³
    participant IS as æ¥å£æœåŠ¡
    participant DB as MySQLæ•°æ®åº“
    
    Note over F,DB: 1. é¡µé¢åˆå§‹åŒ–åŠ è½½
    F->>G: GET /api/v1/interfaces/categories
    G->>G: è·¯ç”±åŒ¹é…å’Œè®¤è¯
    G->>IS: è½¬å‘è¯·æ±‚åˆ°æ¥å£æœåŠ¡
    IS->>DB: SELECT * FROM interface_categories
    DB-->>IS: è¿”å›åˆ†ç±»æ•°æ®
    IS-->>G: è¿”å›åˆ†ç±»åˆ—è¡¨
    G-->>F: è¿”å›JSONå“åº”
    
    Note over F,DB: 2. æ ¹æ®åˆ†ç±»åŠ è½½æ¥å£åˆ—è¡¨
    F->>G: GET /api/v1/interfaces?category=power&page=1&size=20
    G->>IS: è½¬å‘è¯·æ±‚
    IS->>DB: å¤æ‚æŸ¥è¯¢æ¥å£ä¿¡æ¯
    Note over IS,DB: SELECT i.*, ds.source_name, u.real_name as creator<br/>FROM interfaces i<br/>LEFT JOIN data_sources ds ON i.data_source_id = ds.id<br/>LEFT JOIN users u ON i.created_by = u.id<br/>WHERE i.status = 'published' AND i.category = ?<br/>ORDER BY i.created_at DESC<br/>LIMIT ?, ?
    DB-->>IS: è¿”å›æ¥å£åˆ—è¡¨
    IS-->>G: è¿”å›æ¥å£åˆ—è¡¨
    G-->>F: è¿”å›åˆ†é¡µæ•°æ®
```

#### 7.1.2 æ•°æ®å¤„ç†é€»è¾‘

**å‰ç«¯æ•°æ®å¤„ç†**ï¼š

```javascript
// InterfaceCatalog.vue
export default {
  data() {
    return {
      categories: [],
      interfaces: [],
      loading: false,
      pagination: {
        current: 1,
        pageSize: 20,
        total: 0
      }
    }
  },
  
  async mounted() {
    await this.loadCategories()
    await this.loadInterfaces()
  },
  
  methods: {
    async loadCategories() {
      try {
        const response = await this.$http.get('/api/v1/interfaces/categories')
        this.categories = response.data.data
      } catch (error) {
        this.$message.error('åŠ è½½åˆ†ç±»å¤±è´¥')
      }
    },
    
    async loadInterfaces(category = '', page = 1) {
      this.loading = true
      try {
        const params = {
          category,
          page,
          size: this.pagination.pageSize
        }
        const response = await this.$http.get('/api/v1/interfaces', { params })
        this.interfaces = response.data.data.records
        this.pagination.total = response.data.data.total
      } catch (error) {
        this.$message.error('åŠ è½½æ¥å£åˆ—è¡¨å¤±è´¥')
      } finally {
        this.loading = false
      }
    }
  }
}
```

**åç«¯ä¸šåŠ¡é€»è¾‘**ï¼š

```java
@RestController
@RequestMapping("/api/v1/interfaces")
public class InterfaceController {
    
    @Autowired
    private InterfaceService interfaceService;
    
    @GetMapping("/categories")
    public ResponseEntity<ApiResponse<List<CategoryVO>>> getCategories() {
        List<CategoryVO> categories = interfaceService.getCategories();
        return ResponseEntity.ok(ApiResponse.success(categories));
    }
    
    @GetMapping
    public ResponseEntity<ApiResponse<PageResult<InterfaceVO>>> getInterfaces(
            @RequestParam(required = false) String category,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        PageRequest pageRequest = PageRequest.of(page - 1, size);
        PageResult<InterfaceVO> result = interfaceService.getInterfaces(category, pageRequest);
        return ResponseEntity.ok(ApiResponse.success(result));
    }
}

@Service
public class InterfaceService {
    
    @Autowired
    private InterfaceMapper interfaceMapper;
    
    public List<CategoryVO> getCategories() {
        return interfaceMapper.selectCategories();
    }
    
    public PageResult<InterfaceVO> getInterfaces(String category, PageRequest pageRequest) {
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        QueryWrapper<Interface> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("status", "published");
        if (StringUtils.isNotBlank(category)) {
            queryWrapper.eq("category", category);
        }
        queryWrapper.orderByDesc("created_at");
        
        // åˆ†é¡µæŸ¥è¯¢
        Page<Interface> page = new Page<>(pageRequest.getPageNumber() + 1, pageRequest.getPageSize());
        Page<Interface> result = interfaceMapper.selectPage(page, queryWrapper);
        
        // è½¬æ¢ä¸ºVO
        List<InterfaceVO> voList = result.getRecords().stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
            
        return new PageResult<>(voList, result.getTotal(), result.getCurrent(), result.getSize());
    }
}
```

### 7.2 æ¥å£ç”Ÿæˆè°ƒç”¨é“¾è·¯

#### 7.2.1 å®Œæ•´è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant F as Vueå‰ç«¯
    participant G as Gatewayç½‘å…³
    participant IS as æ¥å£æœåŠ¡
    participant DS as æ•°æ®æºæœåŠ¡
    participant GS as ç½‘å…³æœåŠ¡
    participant R as Redisç¼“å­˜
    participant DB as MySQLæ•°æ®åº“
    
    Note over F,DB: æ¥å£ç”Ÿæˆå®Œæ•´æµç¨‹
    
    F->>G: POST /api/v1/interfaces/generate
    Note over F: è¯·æ±‚ä½“åŒ…å«ï¼šæ•°æ®åº“è¡¨åã€æ¥å£é…ç½®ã€SQLæ¨¡æ¿ç­‰
    
    G->>G: JWT TokenéªŒè¯
    G->>G: æƒé™æ£€æŸ¥(interface:create)
    G->>IS: è½¬å‘åˆ°æ¥å£æœåŠ¡
    
    IS->>IS: å‚æ•°éªŒè¯å’Œä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    IS->>DB: éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
    DB-->>IS: è¿”å›è¡¨ç»“æ„ä¿¡æ¯
    
    alt æ•°æ®åº“è¡¨ä¸å­˜åœ¨
        IS-->>G: è¿”å›è¡¨ä¸å­˜åœ¨é”™è¯¯
        G-->>F: è¿”å›400é”™è¯¯
    else è¡¨ç»“æ„éªŒè¯é€šè¿‡
        IS->>IS: ç”Ÿæˆæ¥å£ä»£ç å’Œé…ç½®
        IS->>DB: ä¿å­˜æ¥å£ä¿¡æ¯
        Note over IS,DB: INSERT INTO interfaces (name, path, sql_template, ...)
        
        IS-->>G: è¿”å›ç”Ÿæˆç»“æœ
        G-->>F: è¿”å›æˆåŠŸå“åº”
        
        Note over IS: æ¥å£ç”Ÿæˆå®Œæˆï¼ŒçŠ¶æ€ä¸ºæœªä¸Šæ¶
    end
```

#### 7.2.2 æ¥å£ç”Ÿæˆæ ¸å¿ƒä»£ç 

**å‰ç«¯æ¥å£ç”Ÿæˆç»„ä»¶**ï¼š

```javascript
// InterfaceGenerateDialog.vue
export default {
  data() {
    return {
      currentStep: 1,
      formData: {
        dataSourceId: null,
        interfaceName: '',
        interfacePath: '',
        description: '',
        sqlTemplate: '',
        parameters: []
      }
    }
  },
  
  methods: {
    async submitGenerate() {
      try {
        this.loading = true
        const response = await this.$http.post('/api/v1/interfaces/generate', this.formData)
        
        this.$message.success('æ¥å£ç”ŸæˆæˆåŠŸ')
        this.$emit('generated', response.data.data)
        this.closeDialog()
      } catch (error) {
        this.$message.error(error.response?.data?.message || 'æ¥å£ç”Ÿæˆå¤±è´¥')
      } finally {
        this.loading = false
      }
    }
  }
}
```

**åç«¯æ¥å£ç”ŸæˆæœåŠ¡**ï¼š

```java
@Service
@Transactional
public class InterfaceGenerateService {
    
    @Autowired
    private InterfaceMapper interfaceMapper;
    
    @Autowired
    private DatabaseTableService databaseTableService;
    
    @Autowired
    private GatewayRouteService gatewayRouteService;
    
    public InterfaceVO generateInterface(InterfaceGenerateRequest request) {
        // 1. éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
        if (!validateDatabaseTable(request.getTableName())) {
            throw new BusinessException("æ•°æ®åº“è¡¨ä¸å­˜åœ¨æˆ–æ— è®¿é—®æƒé™");
        }
        
        // 2. éªŒè¯SQLæ¨¡æ¿
        validateSqlTemplate(request.getSqlTemplate());
        
        // 3. ç”Ÿæˆæ¥å£è·¯å¾„
        String interfacePath = generateInterfacePath(request.getInterfaceName());
        
        // 4. åˆ›å»ºæ¥å£è®°å½•
        Interface interfaceEntity = new Interface();
        interfaceEntity.setInterfaceName(request.getInterfaceName());
        interfaceEntity.setInterfacePath(interfacePath);
        interfaceEntity.setDescription(request.getDescription());
        interfaceEntity.setSqlTemplate(request.getSqlTemplate());
        interfaceEntity.setStatus("draft");
        interfaceEntity.setCreatedBy(getCurrentUserId());
        interfaceEntity.setCreatedAt(LocalDateTime.now());
        
        interfaceMapper.insert(interfaceEntity);
        
        // 5. ä¿å­˜æ¥å£å‚æ•°
        saveInterfaceParameters(interfaceEntity.getId(), request.getParameters());
        
        return convertToVO(interfaceEntity);
    }
    
    private void validateSqlTemplate(String sqlTemplate) {
        // SQLæ³¨å…¥æ£€æŸ¥
        if (containsDangerousKeywords(sqlTemplate)) {
            throw new BusinessException("SQLæ¨¡æ¿åŒ…å«å±é™©å…³é”®å­—");
        }
        
        // SQLè¯­æ³•æ£€æŸ¥
        try {
            JSqlParser.parse(sqlTemplate);
        } catch (Exception e) {
            throw new BusinessException("SQLæ¨¡æ¿è¯­æ³•é”™è¯¯: " + e.getMessage());
        }
    }
}
```

### 7.3 è®¢é˜…ç”³è¯·å®¡æ‰¹è°ƒç”¨é“¾è·¯

#### 7.3.1 ç”³è¯·æäº¤æµç¨‹

```mermaid
sequenceDiagram
    participant C as æ¶ˆè´¹è€…å‰ç«¯
    participant G as Gatewayç½‘å…³
    participant AS as å®¡æ‰¹æœåŠ¡
    participant US as ç”¨æˆ·æœåŠ¡
    participant NS as é€šçŸ¥æœåŠ¡
    participant R as Redisç¼“å­˜
    participant DB as MySQLæ•°æ®åº“
    participant Email as é‚®ä»¶æœåŠ¡
    
    C->>G: POST /api/v1/applications/subscribe
    G->>G: è®¤è¯å’Œæƒé™æ£€æŸ¥
    G->>AS: è½¬å‘è®¢é˜…ç”³è¯·
    
    AS->>AS: éªŒè¯ç”³è¯·å‚æ•°
    AS->>DB: æ£€æŸ¥é‡å¤ç”³è¯·
    Note over AS,DB: SELECT COUNT(*) FROM subscription_applications<br/>WHERE user_id = ? AND interface_id = ?<br/>AND status IN ('pending', 'approved')
    
    alt å­˜åœ¨é‡å¤ç”³è¯·
        AS-->>G: è¿”å›é‡å¤ç”³è¯·é”™è¯¯
        G-->>C: è¿”å›400é”™è¯¯
    else å¯ä»¥ç”³è¯·
        AS->>DB: ä¿å­˜ç”³è¯·è®°å½•
        Note over AS,DB: INSERT INTO subscription_applications<br/>(user_id, interface_id, reason, status, applied_at)
        
        AS->>US: è·å–å®¡æ‰¹äººå‘˜åˆ—è¡¨
        US->>DB: æŸ¥è¯¢ç»“ç®—éƒ¨äººå‘˜
        DB-->>US: è¿”å›å®¡æ‰¹äººå‘˜
        US-->>AS: è¿”å›å®¡æ‰¹äººå‘˜åˆ—è¡¨
        
        AS->>NS: å‘é€å®¡æ‰¹é€šçŸ¥
        NS->>Email: å‘é€é‚®ä»¶é€šçŸ¥
        NS->>R: ç¼“å­˜é€šçŸ¥æ¶ˆæ¯
        
        AS-->>G: è¿”å›ç”³è¯·æˆåŠŸ
        G-->>C: è¿”å›æˆåŠŸå“åº”
    end
```

#### 7.3.2 å®¡æ‰¹å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant A as å®¡æ‰¹äººå‰ç«¯
    participant G as Gatewayç½‘å…³
    participant AS as å®¡æ‰¹æœåŠ¡
    participant US as ç”¨æˆ·æœåŠ¡
    participant NS as é€šçŸ¥æœåŠ¡
    participant R as Redisç¼“å­˜
    participant DB as MySQLæ•°æ®åº“
    
    A->>G: PUT /api/v1/applications/{id}/approve
    G->>AS: è½¬å‘å®¡æ‰¹è¯·æ±‚
    
    AS->>DB: æŸ¥è¯¢ç”³è¯·è¯¦æƒ…
    AS->>AS: éªŒè¯å®¡æ‰¹æƒé™
    
    alt å®¡æ‰¹é€šè¿‡
        AS->>DB: æ›´æ–°ç”³è¯·çŠ¶æ€ä¸ºapproved
        AS->>DB: è®°å½•å®¡æ‰¹å†å²
        AS->>US: æ›´æ–°ç”¨æˆ·æ¥å£æƒé™
        US->>R: æ›´æ–°æƒé™ç¼“å­˜
        AS->>NS: å‘é€é€šè¿‡é€šçŸ¥
    else å®¡æ‰¹æ‹’ç»
        AS->>DB: æ›´æ–°ç”³è¯·çŠ¶æ€ä¸ºrejected
        AS->>DB: è®°å½•æ‹’ç»åŸå› 
        AS->>NS: å‘é€æ‹’ç»é€šçŸ¥
    end
    
    AS-->>G: è¿”å›å®¡æ‰¹ç»“æœ
    G-->>A: è¿”å›æˆåŠŸå“åº”
```

### 7.4 APIè°ƒç”¨è®¤è¯è°ƒç”¨é“¾è·¯

#### 7.4.1 APIè°ƒç”¨å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯åº”ç”¨
    participant G as Gatewayç½‘å…³
    participant AF as è®¤è¯è¿‡æ»¤å™¨
    participant IS as æ¥å£æœåŠ¡
    participant DS as æ•°æ®æºæœåŠ¡
    participant AL as å®¡è®¡æ—¥å¿—
    participant R as Redisç¼“å­˜
    participant DB as MySQLæ•°æ®åº“
    
    Client->>G: GET /api/data/{interfaceId}?param1=value1
    Note over Client: Headers: X-API-Key: abc123...
    
    G->>AF: è·¯ç”±åˆ°è®¤è¯è¿‡æ»¤å™¨
    AF->>R: æ£€æŸ¥API Keyç¼“å­˜
    
    alt API Keyç¼“å­˜å­˜åœ¨
        R-->>AF: è¿”å›ç”¨æˆ·æƒé™ä¿¡æ¯
    else ç¼“å­˜ä¸å­˜åœ¨
        AF->>DB: æŸ¥è¯¢API Keyå’Œæƒé™
        Note over AF,DB: SELECT ak.*, u.status, u.id as user_id<br/>FROM api_keys ak<br/>JOIN users u ON ak.user_id = u.id<br/>WHERE ak.api_key = ? AND ak.status = 1
        DB-->>AF: è¿”å›Keyä¿¡æ¯
        AF->>R: ç¼“å­˜æƒé™ä¿¡æ¯(TTL:15åˆ†é’Ÿ)
    end
    
    AF->>AF: éªŒè¯æ¥å£è®¿é—®æƒé™
    alt æƒé™éªŒè¯å¤±è´¥
        AF->>AL: è®°å½•è®¿é—®æ‹’ç»æ—¥å¿—
        AF-->>G: è¿”å›403é”™è¯¯
        G-->>Client: è¿”å›æƒé™é”™è¯¯
    else æƒé™éªŒè¯é€šè¿‡
        AF->>G: ç»§ç»­å¤„ç†è¯·æ±‚
        G->>IS: è½¬å‘åˆ°æ¥å£æœåŠ¡
        
        IS->>DB: æŸ¥è¯¢æ¥å£é…ç½®
        IS->>DS: æ‰§è¡Œæ•°æ®æŸ¥è¯¢
        DS->>DS: æ„å»ºSQLå¹¶æ‰§è¡Œ
        DS-->>IS: è¿”å›æŸ¥è¯¢ç»“æœ
        
        IS->>AL: è®°å½•APIè°ƒç”¨æ—¥å¿—
        IS-->>G: è¿”å›ä¸šåŠ¡æ•°æ®
        G-->>Client: è¿”å›APIç»“æœ
    end
```

#### 7.4.2 è®¤è¯è¿‡æ»¤å™¨å®ç°

```java
@Component
public class ApiKeyAuthenticationFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ApiKeyService apiKeyService;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦API Keyè®¤è¯
        if (!requiresApiKeyAuth(request.getPath().value())) {
            return chain.filter(exchange);
        }
        
        // æå–API Key
        String apiKey = extractApiKey(request);
        if (StringUtils.isEmpty(apiKey)) {
            return handleAuthError(exchange, "Missing API Key");
        }
        
        // éªŒè¯API Key
        return validateApiKey(apiKey)
            .flatMap(userInfo -> {
                // æ£€æŸ¥æ¥å£æƒé™
                String interfaceId = extractInterfaceId(request.getPath().value());
                if (!hasInterfacePermission(userInfo, interfaceId)) {
                    return handleAuthError(exchange, "Insufficient permissions");
                }
                
                // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                ServerHttpRequest mutatedRequest = request.mutate()
                    .header("X-User-Id", userInfo.getUserId().toString())
                    .header("X-User-Role", userInfo.getRole())
                    .build();
                    
                return chain.filter(exchange.mutate().request(mutatedRequest).build());
            })
            .onErrorResume(throwable -> {
                log.error("API Key validation failed", throwable);
                return handleAuthError(exchange, "Invalid API Key");
            });
    }
    
    private Mono<UserInfo> validateApiKey(String apiKey) {
        // å…ˆæ£€æŸ¥ç¼“å­˜
        String cacheKey = "api_key:" + apiKey;
        UserInfo cachedUserInfo = (UserInfo) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedUserInfo != null) {
            return Mono.just(cachedUserInfo);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        return apiKeyService.validateApiKey(apiKey)
            .doOnNext(userInfo -> {
                // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
                redisTemplate.opsForValue().set(cacheKey, userInfo, Duration.ofMinutes(15));
            });
    }
}
```

## 8. APIæ¥å£å®šä¹‰

### 8.1 ç”¨æˆ·è®¤è¯ç›¸å…³API

#### 8.1.1 ç”¨æˆ·ç™»å½•

```
POST /api/v1/auth/login
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å   | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| -------- | -------- | -------- | ------ |
| username | string   | æ˜¯       | ç”¨æˆ·å |
| password | string   | æ˜¯       | å¯†ç    |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```json
{
  "username": "zhangsan",
  "password": "123456"
}
```

**å“åº”å‚æ•°**ï¼š

| å‚æ•°å                    | å‚æ•°ç±»å‹ | æè¿°        |
| ------------------------- | -------- | ----------- |
| code                      | integer  | å“åº”ç       |
| message                   | string   | å“åº”æ¶ˆæ¯    |
| data                      | object   | å“åº”æ•°æ®    |
| data.token                | string   | JWTè®¿é—®ä»¤ç‰Œ |
| data.userInfo             | object   | ç”¨æˆ·ä¿¡æ¯    |
| data.userInfo.id          | integer  | ç”¨æˆ·ID      |
| data.userInfo.username    | string   | ç”¨æˆ·å      |
| data.userInfo.realName    | string   | çœŸå®å§“å    |
| data.userInfo.role        | string   | ç”¨æˆ·è§’è‰²    |
| data.userInfo.permissions | array    | æƒé™åˆ—è¡¨    |

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "id": 1001,
      "username": "zhangsan",
      "realName": "å¼ ä¸‰",
      "role": "tech",
      "permissions": [
        "interface:read",
        "interface:create"
      ]
    }
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### 8.1.2 ç”¨æˆ·ç™»å‡º

```
POST /api/v1/auth/logout
```

**è¯·æ±‚å¤´**ï¼š

| å‚æ•°å        | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°           |
| ------------- | -------- | -------- | -------------- |
| Authorization | string   | æ˜¯       | Bearer {token} |

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "message": "ç™»å‡ºæˆåŠŸ",
  "data": null,
  "timestamp": "2024-01-15T10:35:00Z"
}
```

### 8.2 æ¥å£ç®¡ç†ç›¸å…³API

#### 8.2.1 è·å–æ¥å£åˆ—è¡¨

```
GET /api/v1/interfaces
```

**æŸ¥è¯¢å‚æ•°**ï¼š

| å‚æ•°å   | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°                                                 |
| -------- | -------- | -------- | ---------------------------------------------------- |
| category | string   | å¦       | æ¥å£åˆ†ç±»                                             |
| status   | string   | å¦       | æ¥å£çŠ¶æ€(draft/developed/unlisted/published/offline) |
| keyword  | string   | å¦       | æœç´¢å…³é”®è¯                                           |
| page     | integer  | å¦       | é¡µç ï¼Œé»˜è®¤1                                          |
| size     | integer  | å¦       | æ¯é¡µå¤§å°ï¼Œé»˜è®¤20                                     |

**å“åº”å‚æ•°**ï¼š

| å‚æ•°å       | å‚æ•°ç±»å‹ | æè¿°     |
| ------------ | -------- | -------- |
| code         | integer  | å“åº”ç    |
| message      | string   | å“åº”æ¶ˆæ¯ |
| data         | object   | åˆ†é¡µæ•°æ® |
| data.records | array    | æ¥å£åˆ—è¡¨ |
| data.total   | integer  | æ€»è®°å½•æ•° |
| data.current | integer  | å½“å‰é¡µç  |
| data.size    | integer  | æ¯é¡µå¤§å° |

#### 8.2.2 ç”Ÿæˆæ¥å£

```
POST /api/v1/interfaces/generate
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å        | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°        |
| ------------- | -------- | -------- | ----------- |
| dataSourceId  | integer  | æ˜¯       | æ•°æ®æºID    |
| interfaceName | string   | æ˜¯       | æ¥å£åç§°    |
| interfacePath | string   | æ˜¯       | æ¥å£è·¯å¾„    |
| description   | string   | å¦       | æ¥å£æè¿°    |
| sqlTemplate   | string   | æ˜¯       | SQLæŸ¥è¯¢æ¨¡æ¿ |
| parameters    | array    | å¦       | å‚æ•°å®šä¹‰    |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```json
{
  "dataSourceId": 1,
  "interfaceName": "ç”µåŠ›è´Ÿè·æ•°æ®æŸ¥è¯¢",
  "interfacePath": "/power/load",
  "description": "æŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´çš„ç”µåŠ›è´Ÿè·æ•°æ®",
  "sqlTemplate": "SELECT * FROM power_load WHERE date_time BETWEEN #{startTime} AND #{endTime}",
  "parameters": [
    {
      "paramName": "startTime",
      "paramType": "datetime",
      "isRequired": true,
      "description": "å¼€å§‹æ—¶é—´"
    },
    {
      "paramName": "endTime",
      "paramType": "datetime",
      "isRequired": true,
      "description": "ç»“æŸæ—¶é—´"
    }
  ]
}
```

#### 8.2.3 æ‰¹é‡æ¥å£æ“ä½œ

```
POST /api/v1/interfaces/batch-operation
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å       | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°                             |
| ------------ | -------- | -------- | -------------------------------- |
| interfaceIds | array    | æ˜¯       | æ¥å£IDåˆ—è¡¨                       |
| operation    | string   | æ˜¯       | æ“ä½œç±»å‹(publish/offline/reject) |
| reason       | string   | å¦       | æ“ä½œåŸå›                          |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```json
{
  "interfaceIds": [1, 2, 3, 4, 5],
  "operation": "publish",
  "reason": "æ‰¹é‡ä¸Šæ¶ç”µåŠ›äº¤æ˜“ç›¸å…³æ¥å£"
}
```

**å“åº”å‚æ•°**ï¼š

| å‚æ•°å     | å‚æ•°ç±»å‹ | æè¿°                       |
| ---------- | -------- | -------------------------- |
| taskId     | string   | æ‰¹é‡æ“ä½œä»»åŠ¡ID             |
| totalCount | integer  | æ€»æ“ä½œæ•°é‡                 |
| status     | string   | ä»»åŠ¡çŠ¶æ€(completed/failed) |

#### 8.2.4 æ‰¹é‡æ“ä½œçŠ¶æ€æŸ¥è¯¢

```
GET /api/v1/interfaces/batch-operation/{taskId}
```

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| ------ | -------- | -------- | ------ |
| taskId | string   | æ˜¯       | ä»»åŠ¡ID |

**å“åº”å‚æ•°**ï¼š

| å‚æ•°å   | å‚æ•°ç±»å‹ | æè¿°                               |
| -------- | -------- | ---------------------------------- |
| taskId   | string   | ä»»åŠ¡ID                             |
| status   | string   | ä»»åŠ¡çŠ¶æ€(running/completed/failed) |
| progress | object   | è¿›åº¦ä¿¡æ¯                           |
| results  | array    | æ“ä½œç»“æœåˆ—è¡¨                       |

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "taskId": "batch_20240115_001",
    "status": "completed",
    "progress": {
      "total": 5,
      "success": 4,
      "failed": 1,
      "percentage": 100
    },
    "results": [
      {
        "interfaceId": 1,
        "status": "success",
        "message": "æ¥å£ä¸Šæ¶æˆåŠŸ"
      },
      {
        "interfaceId": 2,
        "status": "failed",
        "message": "æ¥å£çŠ¶æ€ä¸ç¬¦åˆä¸Šæ¶æ¡ä»¶"
      }
    ]
  }
}
```

**è¯´æ˜**ï¼šæ‰¹é‡æ“ä½œé‡‡ç”¨åŒæ­¥å¤„ç†æ–¹å¼ï¼Œç›´æ¥è¿”å›æ‰€æœ‰æ“ä½œç»“æœï¼Œæ— éœ€å¼‚æ­¥æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚

#### 8.2.5 é‡è¯•å¤±è´¥çš„æ‰¹é‡æ“ä½œ

```
POST /api/v1/interfaces/batch-operation/{taskId}/retry
```

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| ------ | -------- | -------- | ------ |
| taskId | string   | æ˜¯       | ä»»åŠ¡ID |

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å       | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
| ------------ | -------- | -------- | ---------------- |
| interfaceIds | array    | å¦       | æŒ‡å®šé‡è¯•çš„æ¥å£ID |

#### 8.2.6 æ¥å£çŠ¶æ€å˜æ›´

```
PUT /api/v1/interfaces/{id}/status
```

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| ------ | -------- | -------- | ------ |
| id     | integer  | æ˜¯       | æ¥å£ID |

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°                                                 |
| ------ | -------- | -------- | ---------------------------------------------------- |
| status | string   | æ˜¯       | æ¥å£çŠ¶æ€(draft/developed/unlisted/published/offline) |
| reason | string   | å¦       | çŠ¶æ€å˜æ›´åŸå›                                          |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```json
{
  "status": "published",
  "reason": "æ¥å£æµ‹è¯•é€šè¿‡ï¼Œæ­£å¼ä¸Šæ¶"
}
```

### 8.3 è®¢é˜…ç”³è¯·ç›¸å…³API

#### 8.3.1 æäº¤è®¢é˜…ç”³è¯·

```
POST /api/v1/applications/subscribe
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å            | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°     |
| ----------------- | -------- | -------- | -------- |
| interfaceId       | integer  | æ˜¯       | æ¥å£ID   |
| applicationReason | string   | æ˜¯       | ç”³è¯·ç†ç”± |
| businessScenario  | string   | æ˜¯       | ä¸šåŠ¡åœºæ™¯ |

#### 8.3.2 å®¡æ‰¹ç”³è¯·

```
PUT /api/v1/applications/{id}/approve
```

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| ------ | -------- | -------- | ------ |
| id     | integer  | æ˜¯       | ç”³è¯·ID |

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å  | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°                     |
| ------- | -------- | -------- | ------------------------ |
| action  | string   | æ˜¯       | å®¡æ‰¹åŠ¨ä½œ(approve/reject) |
| comment | string   | å¦       | å®¡æ‰¹æ„è§                 |

### 8.4 é€šçŸ¥ç®¡ç†ç›¸å…³API

#### 8.4.1 è·å–ç”¨æˆ·é€šçŸ¥åˆ—è¡¨

```
GET /api/v1/notifications
```

**æŸ¥è¯¢å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°                                          |
| ------ | -------- | -------- | --------------------------------------------- |
| type   | string   | å¦       | é€šçŸ¥ç±»å‹(interface\_offline/approval\_result) |
| status | string   | å¦       | è¯»å–çŠ¶æ€(read/unread)                         |
| page   | integer  | å¦       | é¡µç ï¼Œé»˜è®¤1                                   |
| size   | integer  | å¦       | æ¯é¡µå¤§å°ï¼Œé»˜è®¤20                              |

**å“åº”å‚æ•°**ï¼š

| å‚æ•°å       | å‚æ•°ç±»å‹ | æè¿°     |
| ------------ | -------- | -------- |
| code         | integer  | å“åº”ç    |
| message      | string   | å“åº”æ¶ˆæ¯ |
| data         | object   | åˆ†é¡µæ•°æ® |
| data.records | array    | é€šçŸ¥åˆ—è¡¨ |
| data.total   | integer  | æ€»è®°å½•æ•° |

#### 8.4.2 æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»

```
PUT /api/v1/notifications/{id}/read
```

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°   |
| ------ | -------- | -------- | ------ |
| id     | integer  | æ˜¯       | é€šçŸ¥ID |

#### 8.4.3 æ‰¹é‡æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»

```
PUT /api/v1/notifications/batch-read
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å          | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°       |
| --------------- | -------- | -------- | ---------- |
| notificationIds | array    | æ˜¯       | é€šçŸ¥IDåˆ—è¡¨ |

#### 8.4.4 å‘é€æ¥å£ä¸‹æ¶é€šçŸ¥

```
POST /api/v1/notifications/interface-offline
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å      | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°         |
| ----------- | -------- | -------- | ------------ |
| interfaceId | integer  | æ˜¯       | æ¥å£ID       |
| reason      | string   | æ˜¯       | ä¸‹æ¶åŸå›      |
| userIds     | array    | å¦       | æŒ‡å®šé€šçŸ¥ç”¨æˆ· |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```json
{
  "interfaceId": 123,
  "reason": "æ¥å£ç»´æŠ¤å‡çº§",
  "userIds": [1, 2, 3]
}
```

### 8.5 æ•°æ®æ¥å£è°ƒç”¨API

#### 8.5.1 é€šç”¨æ•°æ®æ¥å£

```
GET /api/data/{interfaceId}
```

**è¯·æ±‚å¤´**ï¼š

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°        |
| --------- | -------- | -------- | ----------- |
| X-API-Key | string   | æ˜¯       | APIè®¿é—®å¯†é’¥ |

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å      | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°     |
| ----------- | -------- | -------- | -------- |
| interfaceId | string   | æ˜¯       | æ¥å£æ ‡è¯† |

**æŸ¥è¯¢å‚æ•°**ï¼šæ ¹æ®å…·ä½“æ¥å£å®šä¹‰çš„å‚æ•°

**å“åº”æ ¼å¼**ï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [...],
    "total": 100,
    "page": 1,
    "size": 20
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## 9. æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

### 9.1 æ ¸å¿ƒè¡¨DDLè¯­å¥

#### 9.1.1 ç”¨æˆ·ç›¸å…³è¡¨

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT 'é‚®ç®±åœ°å€',
    password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    real_name VARCHAR(50) NOT NULL COMMENT 'çœŸå®å§“å',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·ç ',
    department VARCHAR(100) COMMENT 'éƒ¨é—¨',
    position VARCHAR(100) COMMENT 'èŒä½',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'è§’è‰²ID',
    role_name VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²åç§°',
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²ç¼–ç ',
    description VARCHAR(200) COMMENT 'è§’è‰²æè¿°',
    permissions JSON COMMENT 'æƒé™åˆ—è¡¨',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²è¡¨';

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å…³è”ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id INT NOT NULL COMMENT 'è§’è‰²ID',
    assigned_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ†é…æ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_role (user_id, role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

#### 9.1.2 æ¥å£ç®¡ç†ç›¸å…³è¡¨

```sql


-- æ¥å£åˆ†ç±»è¡¨
CREATE TABLE interface_categories (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'åˆ†ç±»ID',
    category_name VARCHAR(50) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    category_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'åˆ†ç±»ä»£ç ',
    description TEXT COMMENT 'åˆ†ç±»æè¿°',
    color_code VARCHAR(10) COMMENT 'é¢œè‰²æ ‡è¯†',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_category_code (category_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¥å£åˆ†ç±»è¡¨';

-- æ¥å£è¡¨
CREATE TABLE interfaces (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ¥å£ID',
    interface_name VARCHAR(200) NOT NULL COMMENT 'æ¥å£åç§°',
    interface_path VARCHAR(500) NOT NULL UNIQUE COMMENT 'æ¥å£è·¯å¾„',
    description TEXT COMMENT 'æ¥å£æè¿°',
    category_id INT COMMENT 'åˆ†ç±»ID',
    business_rule_ref VARCHAR(100) COMMENT 'å¯¹åº”æŠ«éœ²è§„åˆ™ç¼–å·',
    
    sql_template TEXT NOT NULL COMMENT 'SQLæŸ¥è¯¢æ¨¡æ¿',
    request_params JSON COMMENT 'è¯·æ±‚å‚æ•°å®šä¹‰',
    response_format JSON COMMENT 'å“åº”æ ¼å¼å®šä¹‰',
    table_type VARCHAR(50) COMMENT 'æ•°æ®è¡¨ç±»å‹(hourly_24,min5_288,device_info)',
    
    status VARCHAR(20) DEFAULT 'draft' COMMENT 'æ¥å£çŠ¶æ€(draft,developed,unpublished,published,offline)',
    created_by BIGINT NOT NULL COMMENT 'åˆ›å»ºäººID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    published_at DATETIME COMMENT 'å‘å¸ƒæ—¶é—´',

    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (category_id) REFERENCES interface_categories(id),
    INDEX idx_interface_path (interface_path),
    INDEX idx_status (status),
    INDEX idx_category_id (category_id),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¥å£è¡¨';

-- æ¥å£å‚æ•°è¡¨
CREATE TABLE interface_parameters (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å‚æ•°ID',
    interface_id BIGINT NOT NULL COMMENT 'æ¥å£ID',
    param_name VARCHAR(100) NOT NULL COMMENT 'å‚æ•°åç§°',
    param_type VARCHAR(50) NOT NULL COMMENT 'å‚æ•°ç±»å‹',
    param_description VARCHAR(200) COMMENT 'å‚æ•°æè¿°',
    is_required TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¿…å¡«(0:å¦,1:æ˜¯)',
    default_value VARCHAR(200) COMMENT 'é»˜è®¤å€¼',
    validation_rule VARCHAR(500) COMMENT 'éªŒè¯è§„åˆ™',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    FOREIGN KEY (interface_id) REFERENCES interfaces(id) ON DELETE CASCADE,
    INDEX idx_interface_id (interface_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¥å£å‚æ•°è¡¨';
```

#### 9.1.3 è®¢é˜…ç”³è¯·ç›¸å…³è¡¨

```sql
-- è®¢é˜…ç”³è¯·è¡¨
CREATE TABLE subscription_applications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”³è¯·ID',
    user_id BIGINT NOT NULL COMMENT 'ç”³è¯·ç”¨æˆ·ID',
    interface_id BIGINT NOT NULL COMMENT 'æ¥å£ID',
    application_reason TEXT NOT NULL COMMENT 'ç”³è¯·ç†ç”±',
    business_scenario TEXT COMMENT 'ä¸šåŠ¡åœºæ™¯',
    status VARCHAR(20) DEFAULT 'pending' COMMENT 'ç”³è¯·çŠ¶æ€(pending,approved,rejected)',
    applied_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ç”³è¯·æ—¶é—´',
    approved_at DATETIME COMMENT 'å®¡æ‰¹æ—¶é—´',
    approved_by BIGINT COMMENT 'å®¡æ‰¹äººID',
    approval_comment TEXT COMMENT 'å®¡æ‰¹æ„è§',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (interface_id) REFERENCES interfaces(id),
    FOREIGN KEY (approved_by) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_interface_id (interface_id),
    INDEX idx_status (status),
    INDEX idx_applied_at (applied_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢é˜…ç”³è¯·è¡¨';

-- å®¡æ‰¹è®°å½•è¡¨
CREATE TABLE approval_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®°å½•ID',
    application_id BIGINT NOT NULL COMMENT 'ç”³è¯·ID',
    approver_id BIGINT NOT NULL COMMENT 'å®¡æ‰¹äººID',
    action VARCHAR(20) NOT NULL COMMENT 'å®¡æ‰¹åŠ¨ä½œ(approve,reject)',
    comment TEXT COMMENT 'å®¡æ‰¹æ„è§',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å®¡æ‰¹æ—¶é—´',
    FOREIGN KEY (application_id) REFERENCES subscription_applications(id) ON DELETE CASCADE,
    FOREIGN KEY (approver_id) REFERENCES users(id),
    INDEX idx_application_id (application_id),
    INDEX idx_approver_id (approver_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å®¡æ‰¹è®°å½•è¡¨';
```

#### 9.1.4 APIå¯†é’¥å’Œæ—¥å¿—è¡¨

```sql
-- ç”¨æˆ·åº”ç”¨IDè¡¨ï¼ˆæ›¿ä»£APIå¯†é’¥ï¼‰
CREATE TABLE user_app_ids (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    app_id VARCHAR(32) NOT NULL UNIQUE COMMENT 'åº”ç”¨ID',
    app_name VARCHAR(100) COMMENT 'åº”ç”¨åç§°',
    permissions JSON COMMENT 'æƒé™èŒƒå›´',
    call_limit_per_day INT DEFAULT 10000 COMMENT 'æ¯æ—¥è°ƒç”¨é™åˆ¶',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    last_used_at DATETIME COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
    expires_at DATETIME COMMENT 'è¿‡æœŸæ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_app_id (app_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·åº”ç”¨IDè¡¨';

-- APIå¯†é’¥è¡¨ï¼ˆä¿ç•™å…¼å®¹ï¼‰
CREATE TABLE api_keys (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å¯†é’¥ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    api_key VARCHAR(64) NOT NULL UNIQUE COMMENT 'APIå¯†é’¥',
    secret_key VARCHAR(128) NOT NULL COMMENT 'ç­¾åå¯†é’¥',
    permissions JSON COMMENT 'æƒé™èŒƒå›´',
    expires_at DATETIME COMMENT 'è¿‡æœŸæ—¶é—´',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    last_used_at DATETIME COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_api_key (api_key),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='APIå¯†é’¥è¡¨';

-- APIè°ƒç”¨æ—¥å¿—è¡¨
CREATE TABLE api_call_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
    app_id VARCHAR(32) COMMENT 'åº”ç”¨ID',
    api_key_id BIGINT COMMENT 'APIå¯†é’¥IDï¼ˆå…¼å®¹å­—æ®µï¼‰',
    interface_id BIGINT COMMENT 'æ¥å£ID',
    request_ip VARCHAR(45) COMMENT 'è¯·æ±‚IP',
    request_method VARCHAR(10) COMMENT 'è¯·æ±‚æ–¹æ³•',
    request_params TEXT COMMENT 'è¯·æ±‚å‚æ•°',
    response_status VARCHAR(10) COMMENT 'å“åº”çŠ¶æ€ï¼ˆ0-æˆåŠŸï¼Œå…¶ä»–-å¤±è´¥ï¼‰',
    response_message VARCHAR(200) COMMENT 'å“åº”æ¶ˆæ¯',
    response_body TEXT COMMENT 'å“åº”å†…å®¹',
    response_time_ms INT COMMENT 'å“åº”æ—¶é—´(æ¯«ç§’)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'è°ƒç”¨æ—¶é—´',
    FOREIGN KEY (api_key_id) REFERENCES api_keys(id),
    FOREIGN KEY (interface_id) REFERENCES interfaces(id),
    INDEX idx_app_id (app_id),
    INDEX idx_api_key_id (api_key_id),
    INDEX idx_interface_id (interface_id),
    INDEX idx_created_at (created_at),
    INDEX idx_request_ip (request_ip)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='APIè°ƒç”¨æ—¥å¿—è¡¨';

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
    user_id BIGINT COMMENT 'æ“ä½œç”¨æˆ·ID',
    operation_type VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    operation_desc VARCHAR(200) NOT NULL COMMENT 'æ“ä½œæè¿°',
    target_type VARCHAR(50) COMMENT 'ç›®æ ‡ç±»å‹',
    target_id VARCHAR(100) COMMENT 'ç›®æ ‡ID',
    operation_data JSON COMMENT 'æ“ä½œæ•°æ®',
    request_ip VARCHAR(45) COMMENT 'è¯·æ±‚IP',
    user_agent VARCHAR(500) COMMENT 'ç”¨æˆ·ä»£ç†',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'æ“ä½œæ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ“ä½œæ—¥å¿—è¡¨';

-- æ‰¹é‡æ“ä½œä»»åŠ¡è¡¨
CREATE TABLE batch_operation_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä»»åŠ¡ID',
    task_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'ä»»åŠ¡æ ‡è¯†',
    user_id BIGINT NOT NULL COMMENT 'æ“ä½œç”¨æˆ·ID',
    operation_type VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹(publish/offline/reject)',
    target_type VARCHAR(50) NOT NULL COMMENT 'ç›®æ ‡ç±»å‹(interface)',
    total_count INT NOT NULL COMMENT 'æ€»æ“ä½œæ•°é‡',
    success_count INT DEFAULT 0 COMMENT 'æˆåŠŸæ•°é‡',
    failed_count INT DEFAULT 0 COMMENT 'å¤±è´¥æ•°é‡',
    status VARCHAR(20) DEFAULT 'running' COMMENT 'ä»»åŠ¡çŠ¶æ€(running/completed/failed)',
    operation_reason TEXT COMMENT 'æ“ä½œåŸå› ',
    started_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å¼€å§‹æ—¶é—´',
    completed_at DATETIME COMMENT 'å®Œæˆæ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_task_id (task_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_started_at (started_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ‰¹é‡æ“ä½œä»»åŠ¡è¡¨';

-- æ‰¹é‡æ“ä½œç»“æœè¡¨
CREATE TABLE batch_operation_results (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç»“æœID',
    task_id VARCHAR(64) NOT NULL COMMENT 'ä»»åŠ¡æ ‡è¯†',
    target_id BIGINT NOT NULL COMMENT 'ç›®æ ‡ID',
    status VARCHAR(20) NOT NULL COMMENT 'æ“ä½œçŠ¶æ€(success/failed/skipped)',
    message TEXT COMMENT 'æ“ä½œç»“æœæ¶ˆæ¯',
    error_code VARCHAR(50) COMMENT 'é”™è¯¯ä»£ç ',
    executed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'æ‰§è¡Œæ—¶é—´',
    FOREIGN KEY (task_id) REFERENCES batch_operation_tasks(task_id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_target_id (target_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ‰¹é‡æ“ä½œç»“æœè¡¨';

-- é€šçŸ¥è¡¨
CREATE TABLE notifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'é€šçŸ¥ID',
    user_id BIGINT NOT NULL COMMENT 'æ¥æ”¶ç”¨æˆ·ID',
    type VARCHAR(50) NOT NULL COMMENT 'é€šçŸ¥ç±»å‹(interface_offline/approval_result/system_notice)',
    title VARCHAR(200) NOT NULL COMMENT 'é€šçŸ¥æ ‡é¢˜',
    content TEXT NOT NULL COMMENT 'é€šçŸ¥å†…å®¹',
    related_type VARCHAR(50) COMMENT 'å…³è”ç±»å‹(interface/application)',
    related_id BIGINT COMMENT 'å…³è”ID',
    status VARCHAR(20) DEFAULT 'unread' COMMENT 'è¯»å–çŠ¶æ€(read/unread)',
    send_methods JSON COMMENT 'å‘é€æ–¹å¼(site/email/sms)',
    send_status JSON COMMENT 'å‘é€çŠ¶æ€',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    read_at DATETIME COMMENT 'è¯»å–æ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥è¡¨';

-- é€šçŸ¥æ¨¡æ¿è¡¨
CREATE TABLE notification_templates (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ¨¡æ¿ID',
    template_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ¨¡æ¿ç¼–ç ',
    template_name VARCHAR(100) NOT NULL COMMENT 'æ¨¡æ¿åç§°',
    type VARCHAR(50) NOT NULL COMMENT 'é€šçŸ¥ç±»å‹',
    title_template VARCHAR(200) NOT NULL COMMENT 'æ ‡é¢˜æ¨¡æ¿',
    content_template TEXT NOT NULL COMMENT 'å†…å®¹æ¨¡æ¿',
    variables JSON COMMENT 'å˜é‡å®šä¹‰',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(0:ç¦ç”¨,1:å¯ç”¨)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX idx_template_code (template_code),
    INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥æ¨¡æ¿è¡¨';
```

### 9.2 åˆå§‹åŒ–æ•°æ®

```sql
-- åˆå§‹åŒ–æ¥å£åˆ†ç±»æ•°æ®
INSERT INTO interface_categories (category_name, category_code, description, color_code, sort_order) VALUES
('æ—¥å‰ç°è´§', 'day_ahead_spot', 'æ—¥å‰ç°è´§å¸‚åœºç›¸å…³æ•°æ®æ¥å£', '#1890ff', 1),
('é¢„æµ‹', 'forecast', 'è´Ÿè·é¢„æµ‹ã€æ–°èƒ½æºé¢„æµ‹ç­‰é¢„æµ‹ç±»æ•°æ®æ¥å£', '#52c41a', 2),
('è¾…åŠ©æœåŠ¡', 'ancillary_service', 'è°ƒé¢‘ã€è°ƒå‹ã€å¤‡ç”¨ç­‰è¾…åŠ©æœåŠ¡æ•°æ®æ¥å£', '#faad14', 3),
('ç”µç½‘è¿è¡Œ', 'grid_operation', 'ç”µç½‘è¿è¡ŒçŠ¶æ€ã€çº¦æŸæƒ…å†µç­‰è¿è¡Œæ•°æ®æ¥å£', '#f5222d', 4);

-- åˆå§‹åŒ–è§’è‰²æ•°æ®
INSERT INTO roles (role_name, role_code, description, permissions) VALUES
('æ•°æ®æ¶ˆè´¹è€…', 'consumer', 'æ•°æ®æ¶ˆè´¹è€…è§’è‰²', '["interface:read", "subscription:apply"]'),
('æŠ€æœ¯éƒ¨ç®¡ç†å‘˜', 'tech', 'æŠ€æœ¯éƒ¨ç®¡ç†å‘˜è§’è‰²', '["interface:read", "interface:create", "interface:update", "audit:read"]'),
('ç»“ç®—éƒ¨ç®¡ç†å‘˜', 'finance', 'ç»“ç®—éƒ¨ç®¡ç†å‘˜è§’è‰²', '["interface:read", "interface:publish", "application:approve", "audit:read"]'),
('ç³»ç»Ÿç®¡ç†å‘˜', 'admin', 'ç³»ç»Ÿç®¡ç†å‘˜è§’è‰²', '["*"]');

-- åˆå§‹åŒ–ç®¡ç†å‘˜ç”¨æˆ·
INSERT INTO users (username, email, password_hash, real_name, department, position) VALUES
('admin', 'admin@powertrading.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaYMk6j8Ej2Gy', 'ç³»ç»Ÿç®¡ç†å‘˜', 'ITéƒ¨', 'ç³»ç»Ÿç®¡ç†å‘˜');

-- åˆ†é…ç®¡ç†å‘˜è§’è‰²
INSERT INTO user_roles (user_id, role_id) VALUES (1, 4);

-- åˆå§‹åŒ–ç®¡ç†å‘˜appId
INSERT INTO user_app_ids (user_id, app_id, app_name, permissions, call_limit_per_day) VALUES
(1, 'ADMIN-SYS-001-MGMT', 'ç³»ç»Ÿç®¡ç†åº”ç”¨', '["*"]', 100000);

-- åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
INSERT INTO system_config (config_key, config_value, description) VALUES
('database.connection.maxPoolSize', '20', 'MySQLè¿æ¥æ± æœ€å¤§è¿æ¥æ•°'),
('database.connection.timeout', '30000', 'MySQLè¿æ¥è¶…æ—¶æ—¶é—´(æ¯«ç§’)');

-- åˆå§‹åŒ–é€šçŸ¥æ¨¡æ¿
INSERT INTO notification_templates (template_code, template_name, type, title_template, content_template, variables) VALUES
('INTERFACE_OFFLINE', 'æ¥å£ä¸‹æ¶é€šçŸ¥', 'interface_offline', 'æ¥å£ä¸‹æ¶é€šçŸ¥', 
 'æ‚¨è®¢é˜…çš„æ¥å£"{{interfaceName}}"å·²äº{{offlineTime}}ä¸‹æ¶\nä¸‹æ¶åŸå› ï¼š{{reason}}\nå½±å“è¯´æ˜ï¼šè¯¥æ¥å£å°†æ— æ³•ç»§ç»­è°ƒç”¨ï¼Œè¯·åŠæ—¶è°ƒæ•´æ‚¨çš„ä¸šåŠ¡ç³»ç»Ÿ\nè”ç³»æ–¹å¼ï¼šå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœç”µè¯ï¼š400-xxx-xxxx\næ“ä½œå»ºè®®ï¼š\n1. è¯·æ£€æŸ¥æ‚¨çš„ç³»ç»Ÿæ˜¯å¦ä¾èµ–æ­¤æ¥å£\n2. å¦‚éœ€ç»§ç»­ä½¿ç”¨ï¼Œè¯·è”ç³»ç›¸å…³éƒ¨é—¨ç”³è¯·æ›¿ä»£æ–¹æ¡ˆ\n3. å»ºè®®è®¢é˜…ç›¸å…³çš„æ›¿ä»£æ¥å£', 
 '{"interfaceName": "æ¥å£åç§°", "offlineTime": "ä¸‹æ¶æ—¶é—´", "reason": "ä¸‹æ¶åŸå› "}'),
('APPROVAL_RESULT', 'è®¢é˜…ç”³è¯·å®¡æ‰¹ç»“æœ', 'approval_result', 'è®¢é˜…ç”³è¯·å®¡æ‰¹ç»“æœé€šçŸ¥',
 'æ‚¨çš„æ¥å£è®¢é˜…ç”³è¯·å·²å¤„ç†å®Œæˆ\næ¥å£åç§°ï¼š{{interfaceName}}\nå®¡æ‰¹ç»“æœï¼š{{result}}\nå®¡æ‰¹æ„è§ï¼š{{comment}}\nå¤„ç†æ—¶é—´ï¼š{{processTime}}',
 '{"interfaceName": "æ¥å£åç§°", "result": "å®¡æ‰¹ç»“æœ", "comment": "å®¡æ‰¹æ„è§", "processTime": "å¤„ç†æ—¶é—´"}'),
('BATCH_OPERATION_RESULT', 'æ‰¹é‡æ“ä½œç»“æœé€šçŸ¥', 'system_notice', 'æ‰¹é‡æ“ä½œå®Œæˆé€šçŸ¥',
 'æ‚¨çš„æ‰¹é‡{{operationType}}æ“ä½œå·²å®Œæˆ\næ“ä½œæ—¶é—´ï¼š{{operationTime}}\næ€»æ•°é‡ï¼š{{totalCount}}\næˆåŠŸï¼š{{successCount}}\nå¤±è´¥ï¼š{{failedCount}}\nå¦‚æœ‰å¤±è´¥é¡¹ç›®ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹è¯¦æƒ…å¹¶é‡è¯•',
 '{"operationType": "æ“ä½œç±»å‹", "operationTime": "æ“ä½œæ—¶é—´", "totalCount": "æ€»æ•°é‡", "successCount": "æˆåŠŸæ•°é‡", "failedCount": "å¤±è´¥æ•°é‡"}'),
('APP_ID_GENERATED', 'appIdç”Ÿæˆé€šçŸ¥', 'system_notice', 'appIdç”ŸæˆæˆåŠŸé€šçŸ¥',
 'æ‚¨çš„åº”ç”¨IDå·²ç”ŸæˆæˆåŠŸ\nappIdï¼š{{appId}}\nåº”ç”¨åç§°ï¼š{{appName}}\næ¯æ—¥è°ƒç”¨é™åˆ¶ï¼š{{callLimit}}æ¬¡\nè¯·å¦¥å–„ä¿ç®¡æ‚¨çš„appIdï¼Œè°ƒç”¨æ¥å£æ—¶éœ€è¦ä½¿ç”¨',
 '{"appId": "åº”ç”¨ID", "appName": "åº”ç”¨åç§°", "callLimit": "è°ƒç”¨é™åˆ¶"}');

-- æ›´æ–°æ¥å£çŠ¶æ€æšä¸¾å€¼
ALTER TABLE interfaces MODIFY COLUMN status VARCHAR(20) DEFAULT 'draft' COMMENT 'æ¥å£çŠ¶æ€(draft:è‰ç¨¿,developed:å·²å¼€å‘,unlisted:æœªä¸Šæ¶,published:å·²ä¸Šæ¶,offline:å·²ä¸‹æ¶)';
```

## 10. éƒ¨ç½²æ¶æ„

### 10.1 å®¹å™¨åŒ–éƒ¨ç½²

#### 10.1.1 Docker Composeé…ç½®

```yaml
version: '3.8'

services:
  # å‰ç«¯åº”ç”¨
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - gateway
    networks:
      - power-trading-network

  # APIç½‘å…³
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
    depends_on:
      - nacos
    networks:
      - power-trading-network

  # ç”¨æˆ·æœåŠ¡
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
    depends_on:
      - mysql
      - nacos
    networks:
      - power-trading-network

  # æ¥å£æœåŠ¡
  interface-service:
    build:
      context: ./interface-service
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
    depends_on:
      - mysql
      - nacos
    networks:
      - power-trading-network

  # å®¡æ‰¹æœåŠ¡
  approval-service:
    build:
      context: ./approval-service
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
    depends_on:
      - mysql
      - nacos
    networks:
      - power-trading-network



  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=power_trading
      - MYSQL_USER=power_user
      - MYSQL_PASSWORD=power123
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - power-trading-network

  # Nacosæ³¨å†Œä¸­å¿ƒ
  nacos:
    image: nacos/nacos-server:v2.2.0
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=root123
    ports:
      - "8848:8848"
    depends_on:
      - mysql
    networks:
      - power-trading-network

volumes:
  mysql_data:

networks:
  power-trading-network:
    driver: bridge
```

### 10.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 10.2.1 Kuberneteséƒ¨ç½²é…ç½®

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: power-trading

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: power-trading
data:
  application.yml: |
    spring:
      profiles:
        active: k8s
      cloud:
        nacos:
          discovery:
            server-addr: nacos-service:8848
          config:
            server-addr: nacos-service:8848
      datasource:
        url: jdbc:mysql://mysql-service:3306/power_trading
        username: power_user
        password: power123

---
# gateway-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: power-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
      - name: gateway
        image: power-trading/gateway:v1.0
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
      volumes:
      - name: config-volume
        configMap:
          name: app-config

---
# gateway-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: power-trading
spec:
  selector:
    app: gateway
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  type: LoadBalancer
```

## 11. ç›‘æ§ä¸è¿ç»´

### 11.1 åº”ç”¨ç›‘æ§

#### 11.1.1 Prometheusç›‘æ§é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "power_trading_rules.yml"

scrape_configs:
  - job_name: 'power-trading-gateway'
    static_configs:
      - targets: ['gateway:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s

  - job_name: 'power-trading-services'
    static_configs:
      - targets: 
        - 'user-service:8081'
        - 'interface-service:8082'
        - 'approval-service:8083'
        - 'audit-service:8084'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s

  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['mysql-exporter:9104']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

#### 11.1.2 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# power_trading_rules.yml
groups:
- name: power_trading_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }} errors per second"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is {{ $value }} seconds"

  - alert: DatabaseConnectionHigh
    expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections > 0.8
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Database connection usage high"
      description: "Database connection usage is {{ $value | humanizePercentage }}"
```

### 11.2 æ—¥å¿—ç®¡ç†

#### 11.2.1 ELK Stacké…ç½®

```yaml
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "power-trading" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:thread} %{DATA:logger} - %{GREEDYDATA:message}" }
    }
    
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    }
    
    if [level] == "ERROR" {
      mutate {
        add_tag => [ "error" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "power-trading-logs-%{+YYYY.MM.dd}"
  }
}
```

## 12. å®‰å…¨æ¶æ„

### 12.1 è®¤è¯æˆæƒæœºåˆ¶

#### 12.1.1 JWT Tokené…ç½®

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint() {
        return new JwtAuthenticationEntryPoint();
    }
    
    @Bean
    public JwtRequestFilter jwtRequestFilter() {
        return new JwtRequestFilter();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public JwtTokenUtil jwtTokenUtil() {
        return new JwtTokenUtil();
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .authorizeRequests()
            .antMatchers("/api/v1/auth/**").permitAll()
            .antMatchers("/api/v1/interfaces/catalog").hasAnyRole("CONSUMER", "TECH", "FINANCE", "ADMIN")
            .antMatchers("/api/v1/interfaces/generate").hasAnyRole("TECH", "ADMIN")
            .antMatchers("/api/v1/applications/approve").hasAnyRole("FINANCE", "ADMIN")
            .anyRequest().authenticated()
            .and()
            .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)
            .and()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
            
        http.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);
    }
}
```

### 12.2 æ•°æ®åŠ å¯†

#### 12.2.1 æ•æ„Ÿæ•°æ®åŠ å¯†å·¥å…·

```java
@Component
public class EncryptionService {
    
    private static final String ALGORITHM = "AES/GCB/PKCS5Padding";
    private static final String KEY_ALGORITHM = "AES";
    
    @Value("${app.encryption.secret-key}")
    private String secretKey;
    
    public String encrypt(String plainText) {
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            SecretKeySpec keySpec = new SecretKeySpec(secretKey.getBytes(), KEY_ALGORITHM);
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            
            byte[] encrypted = cipher.doFinal(plainText.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("Encryption failed", e);
        }
    }
    
    public String decrypt(String encryptedText) {
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            SecretKeySpec keySpec = new SecretKeySpec(secretKey.getBytes(), KEY_ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, keySpec);
            
            byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(encryptedText));
            return new String(decrypted);
        } catch (Exception e) {
            throw new RuntimeException("Decryption failed", e);
        }
    }
}
```

***

## æ–‡æ¡£ç»´æŠ¤ä¿¡æ¯

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0\
**æœ€åæ›´æ–°**ï¼š2024-01-15\
**ç»´æŠ¤äººå‘˜**ï¼šæŠ€æœ¯å›¢é˜Ÿ\
**å®¡æ ¸çŠ¶æ€**ï¼šå¾…å®¡æ ¸

**å˜æ›´è®°å½•**ï¼š

* v1.0ï¼šåˆå§‹æŠ€æœ¯æ¶æ„è®¾è®¡ï¼Œå¯¹åº”PRD v1.0åŠŸèƒ½éœ€æ±‚

* åŒ…å«å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ã€æ•°æ®åº“è®¾è®¡ã€APIå®šä¹‰å’Œéƒ¨ç½²æ–¹æ¡ˆ

* ç§»é™¤æ¥å£ç›‘æ§ç›¸å…³æŠ€æœ¯å®ç°ï¼ˆè®¡åˆ’v2.0ç‰ˆæœ¬ï¼‰

* ç§»é™¤æ—¥å¿—å®¡è®¡ç›¸å…³æŠ€æœ¯å®ç°ï¼ˆè®¡åˆ’v2.0ç‰ˆæœ¬ï¼‰

* ç§»é™¤è®¡è´¹ç®¡ç†ç›¸å…³æŠ€æœ¯æ¶æ„ï¼ˆæš‚ä¸å®ç°ï¼‰